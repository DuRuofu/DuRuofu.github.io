

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://image-1308319148.cos.ap-chengdu.myqcloud.com/main/%E4%B8%AA%E4%BA%BA%E5%A4%B4%E5%83%8F%E6%97%A0%E8%83%8C%E6%99%AF.png">
  <link rel="icon" href="https://image-1308319148.cos.ap-chengdu.myqcloud.com/main/%E4%B8%AA%E4%BA%BA%E5%A4%B4%E5%83%8F%E6%97%A0%E8%83%8C%E6%99%AF.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="DuRuofu">
  <meta name="keywords" content="嵌入式,个人博客,个人测试">
  
    <meta name="description" content="ESP32是Espressif乐鑫信息科技推出的一块WiFi芯片。 拥有40nm工艺、双核32位MCU、2.4GHz双模Wi-Fi和蓝牙芯片、主频高达230MHz,计算能力可达600DMIPS。 -涵盖精细分辨时钟门控、省电模式和动态电压调整等特征。 -它集成了天线和射频巴伦，功率放大器，低噪声放大器，滤波器和电源管理模块等元器件，性能稳定，易于制造，工作温度范围从-40℃到125℃。 -支持多种">
<meta property="og:type" content="article">
<meta property="og:title" content="ESP32wifi入门">
<meta property="og:url" content="https://www.duruofu.xyz/2023/06/06/4.%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/ESP32wifi%E5%85%A5%E9%97%A8/index.html">
<meta property="og:site_name" content="Duruofu&#39;s 个人测试">
<meta property="og:description" content="ESP32是Espressif乐鑫信息科技推出的一块WiFi芯片。 拥有40nm工艺、双核32位MCU、2.4GHz双模Wi-Fi和蓝牙芯片、主频高达230MHz,计算能力可达600DMIPS。 -涵盖精细分辨时钟门控、省电模式和动态电压调整等特征。 -它集成了天线和射频巴伦，功率放大器，低噪声放大器，滤波器和电源管理模块等元器件，性能稳定，易于制造，工作温度范围从-40℃到125℃。 -支持多种">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.duruofu.xyz/img/index_img/esp32.jpg">
<meta property="article:published_time" content="2023-06-06T06:40:53.000Z">
<meta property="article:modified_time" content="2024-01-05T05:40:21.701Z">
<meta property="article:author" content="DuRuofu">
<meta property="article:tag" content="ESP32">
<meta property="article:tag" content="MCU">
<meta property="article:tag" content="WIFI">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://www.duruofu.xyz/img/index_img/esp32.jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>ESP32wifi入门 - Duruofu&#39;s 个人测试</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/cust/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"www.duruofu.xyz","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":80,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":true,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":5},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>DuRuofu</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/2020/06/06/1.%E9%98%85%E8%AF%BB%E5%86%99%E4%BD%9C/%E5%8E%9F%E5%88%9B%E8%AF%97%E8%AF%8D/%E8%AF%97%E8%AF%8D/">
                <i class="iconfont icon-books"></i>
                <span>诗词</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="ESP32wifi入门"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        DuRuofu
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-06-06 14:40" pubdate>
          2023年6月6日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          48k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          80 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">ESP32wifi入门</h1>
            
              <p class="note note-info">
                
                  
                    本文最后更新于：5 个月前
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>ESP32是Espressif乐鑫信息科技推出的一块WiFi芯片。</p>
<p>拥有40nm工艺、双核32位MCU、2.4GHz双模Wi-Fi和蓝牙芯片、主频高达230MHz,计算能力可达600DMIPS。</p>
<p>-涵盖精细分辨时钟门控、省电模式和动态电压调整等特征。</p>
<p>-它集成了天线和射频巴伦，功率放大器，低噪声放大器，滤波器和电源管理模块等元器件，性能稳定，易于制造，工作温度范围从-40℃到125℃。</p>
<p>-支持多种通信协议，如：I2C. I2S. SPI. UART. CAN.</p>
<p>-多种调节管理模式：Active模式、Modem-sleep模式、Light-sleep模式、Deep-sleep模式、Hibernation模式。可根据不同需求，调节所需方案。</p>
<span id="more"></span>
<h2 id="ESP32-wifi入门"><a href="#ESP32-wifi入门" class="headerlink" title="ESP32 wifi入门"></a>ESP32 wifi入门</h2><h3 id="1-WiFi工作流程"><a href="#1-WiFi工作流程" class="headerlink" title="1.WiFi工作流程"></a>1.WiFi工作流程</h3><h4 id="WiFi热点工作流程"><a href="#WiFi热点工作流程" class="headerlink" title="WiFi热点工作流程"></a>WiFi热点工作流程</h4><p><img src="/2023/06/06/4.%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/ESP32wifi%E5%85%A5%E9%97%A8/img29094818.png" srcset="/img/loading.gif" lazyload><br>工作流程如下图所示：<br>示例程序位于：<code>Espressif\frameworks\esp-idf-v4.4.3\examples\wifi\getting_started\softAP</code><br><img src="/2023/06/06/4.%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/ESP32wifi%E5%85%A5%E9%97%A8/img29095457.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="WiFi设备工作流程"><a href="#WiFi设备工作流程" class="headerlink" title="WiFi设备工作流程"></a>WiFi设备工作流程</h4><p>示例代码位于:&#96;Espressif\frameworks\esp-idf-v4.4.3\examples\wifi\getting_started\station<br>与热点流程相似，但是细节有所不同</p>
<p><img src="/2023/06/06/4.%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/ESP32wifi%E5%85%A5%E9%97%A8/img29102938.png" srcset="/img/loading.gif" lazyload></p>
<p>下面是连接wifi的流程：<br><img src="/2023/06/06/4.%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/ESP32wifi%E5%85%A5%E9%97%A8/img29103244.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-TCP协议"><a href="#2-TCP协议" class="headerlink" title="2.TCP协议"></a>2.TCP协议</h3><h4 id="tcp客户端"><a href="#tcp客户端" class="headerlink" title="tcp客户端"></a>tcp客户端</h4><p><img src="/2023/06/06/4.%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/ESP32wifi%E5%85%A5%E9%97%A8/img29105003.png" srcset="/img/loading.gif" lazyload></p>
<p>标准流程：<br>初始化-连接-数据交换-断开连接<br><img src="/2023/06/06/4.%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/ESP32wifi%E5%85%A5%E9%97%A8/img29105602.png" srcset="/img/loading.gif" lazyload><br>客户端和服务端的具体细节：<br><img src="/2023/06/06/4.%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/ESP32wifi%E5%85%A5%E9%97%A8/img29105900.png" srcset="/img/loading.gif" lazyload></p>
<p>示例代码：<code>C:\Espressif\frameworks\esp-idf-v4.4.3\examples\protocols\sockets\tcp_client</code></p>
<p>tcp_client_task  基本流程：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">tcp_client_task</span><span class="hljs-params">(<span class="hljs-type">void</span> *pvParameters)</span><br><br>&#123;<br><br>    <span class="hljs-type">char</span> rx_buffer[<span class="hljs-number">128</span>];<br><br>    <span class="hljs-type">char</span> host_ip[] = HOST_IP_ADDR;<br><br>    <span class="hljs-type">int</span> addr_family = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-type">int</span> ip_protocol = <span class="hljs-number">0</span>;<br><br>  <br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(CONFIG_EXAMPLE_IPV4)</span><br><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">dest_addr</span>;</span><br><br>        dest_addr.sin_addr.s_addr = inet_addr(host_ip);<br><br>        dest_addr.sin_family = AF_INET;<br><br>        dest_addr.sin_port = htons(PORT);<br><br>        addr_family = AF_INET;<br><br>        ip_protocol = IPPROTO_IP;<br><br><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(CONFIG_EXAMPLE_IPV6)</span><br><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in6</span> <span class="hljs-title">dest_addr</span> =</span> &#123; <span class="hljs-number">0</span> &#125;;<br><br>        inet6_aton(host_ip, &amp;dest_addr.sin6_addr);<br><br>        dest_addr.sin6_family = AF_INET6;<br><br>        dest_addr.sin6_port = htons(PORT);<br><br>        dest_addr.sin6_scope_id = esp_netif_get_netif_impl_index(EXAMPLE_INTERFACE);<br><br>        addr_family = AF_INET6;<br><br>        ip_protocol = IPPROTO_IPV6;<br><br><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(CONFIG_EXAMPLE_SOCKET_IP_INPUT_STDIN)</span><br><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_storage</span> <span class="hljs-title">dest_addr</span> =</span> &#123; <span class="hljs-number">0</span> &#125;;<br><br>        ESP_ERROR_CHECK(get_addr_from_stdin(PORT, SOCK_STREAM, &amp;ip_protocol, &amp;addr_family, &amp;dest_addr));<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>        <span class="hljs-comment">//创建套接字</span><br><br>        <span class="hljs-type">int</span> sock =  socket(addr_family, SOCK_STREAM, ip_protocol);<br><br>        <span class="hljs-keyword">if</span> (sock &lt; <span class="hljs-number">0</span>) &#123;<br><br>            ESP_LOGE(TAG, <span class="hljs-string">&quot;Unable to create socket: errno %d&quot;</span>, errno);<br><br>            <span class="hljs-keyword">break</span>;<br><br>        &#125;<br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;Socket created, connecting to %s:%d&quot;</span>, host_ip, PORT);<br><br>        <span class="hljs-comment">//连接服务器</span><br><br>        <span class="hljs-type">int</span> err = connect(sock, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;dest_addr, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sockaddr_in6));<br><br>        <span class="hljs-keyword">if</span> (err != <span class="hljs-number">0</span>) &#123;<br><br>            ESP_LOGE(TAG, <span class="hljs-string">&quot;Socket unable to connect: errno %d&quot;</span>, errno);<br><br>            <span class="hljs-keyword">break</span>;<br><br>        &#125;<br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;Successfully connected&quot;</span>);<br><br>  <br><br>        <span class="hljs-comment">//发送数据</span><br><br>        <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br><br>            <span class="hljs-comment">//发送数据</span><br><br>            <span class="hljs-type">int</span> err = send(sock, payload, <span class="hljs-built_in">strlen</span>(payload), <span class="hljs-number">0</span>);<br><br>            <span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>) &#123;<br><br>                ESP_LOGE(TAG, <span class="hljs-string">&quot;Error occurred during sending: errno %d&quot;</span>, errno);<br><br>                <span class="hljs-keyword">break</span>;<br><br>            &#125;<br><br>            <span class="hljs-comment">//接收数据</span><br><br>            <span class="hljs-type">int</span> len = recv(sock, rx_buffer, <span class="hljs-keyword">sizeof</span>(rx_buffer) - <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br><br>            <span class="hljs-comment">// Error occurred during receiving</span><br><br>            <span class="hljs-keyword">if</span> (len &lt; <span class="hljs-number">0</span>) &#123;<br><br>                ESP_LOGE(TAG, <span class="hljs-string">&quot;recv failed: errno %d&quot;</span>, errno);<br><br>                <span class="hljs-keyword">break</span>;<br><br>            &#125;<br><br>            <span class="hljs-comment">// Data received</span><br><br>            <span class="hljs-keyword">else</span> &#123;<br><br>                rx_buffer[len] = <span class="hljs-number">0</span>; <span class="hljs-comment">// Null-terminate whatever we received and treat like a string</span><br><br>                ESP_LOGI(TAG, <span class="hljs-string">&quot;Received %d bytes from %s:&quot;</span>, len, host_ip);<br><br>                ESP_LOGI(TAG, <span class="hljs-string">&quot;%s&quot;</span>, rx_buffer);<br><br>            &#125;<br><br>  <br><br>            vTaskDelay(<span class="hljs-number">2000</span> / portTICK_PERIOD_MS);<br><br>        &#125;<br><br>  <br><br>        <span class="hljs-keyword">if</span> (sock != <span class="hljs-number">-1</span>) &#123;<br><br>            ESP_LOGE(TAG, <span class="hljs-string">&quot;Shutting down socket and restarting...&quot;</span>);<br><br>            <span class="hljs-comment">//关闭套接字</span><br><br>            shutdown(sock, <span class="hljs-number">0</span>);<br><br>            <span class="hljs-comment">//删除套接字</span><br><br>            close(sock);<br><br>        &#125;<br><br>    &#125;<br><br>    vTaskDelete(<span class="hljs-literal">NULL</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="tcp服务端："><a href="#tcp服务端：" class="headerlink" title="tcp服务端："></a>tcp服务端：</h4><p>参考例程：<code>Espressif\frameworks\esp-idf-v4.4.3\examples\protocols\sockets\tcp_server</code><br>tcp_server_task:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">do_retransmit</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">int</span> sock)</span><br><br>&#123;<br><br>    <span class="hljs-type">int</span> len;<br><br>    <span class="hljs-type">char</span> rx_buffer[<span class="hljs-number">128</span>];<br><br>  <br><br>    <span class="hljs-keyword">do</span> &#123;<br><br>        len = recv(sock, rx_buffer, <span class="hljs-keyword">sizeof</span>(rx_buffer) - <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br><br>        <span class="hljs-keyword">if</span> (len &lt; <span class="hljs-number">0</span>) &#123;<br><br>            ESP_LOGE(TAG, <span class="hljs-string">&quot;Error occurred during receiving: errno %d&quot;</span>, errno);<br><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (len == <span class="hljs-number">0</span>) &#123;<br><br>            ESP_LOGW(TAG, <span class="hljs-string">&quot;Connection closed&quot;</span>);<br><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br><br>            rx_buffer[len] = <span class="hljs-number">0</span>; <span class="hljs-comment">// Null-terminate whatever is received and treat it like a string</span><br><br>            ESP_LOGI(TAG, <span class="hljs-string">&quot;Received %d bytes: %s&quot;</span>, len, rx_buffer);<br><br>  <br><br>            <span class="hljs-comment">// send() can return less bytes than supplied length.</span><br><br>            <span class="hljs-comment">// Walk-around for robust implementation.</span><br><br>            <span class="hljs-type">int</span> to_write = len;<br><br>            <span class="hljs-keyword">while</span> (to_write &gt; <span class="hljs-number">0</span>) &#123;<br><br>                <span class="hljs-type">int</span> written = send(sock, rx_buffer + (len - to_write), to_write, <span class="hljs-number">0</span>);<br><br>                <span class="hljs-keyword">if</span> (written &lt; <span class="hljs-number">0</span>) &#123;<br><br>                    ESP_LOGE(TAG, <span class="hljs-string">&quot;Error occurred during sending: errno %d&quot;</span>, errno);<br><br>                &#125;<br><br>                to_write -= written;<br><br>            &#125;<br><br>        &#125;<br><br>    &#125; <span class="hljs-keyword">while</span> (len &gt; <span class="hljs-number">0</span>);<br><br>&#125;<br><br>  <br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">tcp_server_task</span><span class="hljs-params">(<span class="hljs-type">void</span> *pvParameters)</span><br><br>&#123;<br><br>    <span class="hljs-type">char</span> addr_str[<span class="hljs-number">128</span>];<br><br>    <span class="hljs-type">int</span> addr_family = (<span class="hljs-type">int</span>)pvParameters;<br><br>    <span class="hljs-type">int</span> ip_protocol = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-type">int</span> keepAlive = <span class="hljs-number">1</span>;<br><br>    <span class="hljs-type">int</span> keepIdle = KEEPALIVE_IDLE;<br><br>    <span class="hljs-type">int</span> keepInterval = KEEPALIVE_INTERVAL;<br><br>    <span class="hljs-type">int</span> keepCount = KEEPALIVE_COUNT;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_storage</span> <span class="hljs-title">dest_addr</span>;</span><br><br>  <br><br>    <span class="hljs-keyword">if</span> (addr_family == AF_INET) &#123;<br><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> *<span class="hljs-title">dest_addr_ip4</span> =</span> (<span class="hljs-keyword">struct</span> sockaddr_in *)&amp;dest_addr;<br><br>        dest_addr_ip4-&gt;sin_addr.s_addr = htonl(INADDR_ANY);<br><br>        dest_addr_ip4-&gt;sin_family = AF_INET;<br><br>        dest_addr_ip4-&gt;sin_port = htons(PORT);<br><br>        ip_protocol = IPPROTO_IP;<br><br>    &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_EXAMPLE_IPV6</span><br><br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (addr_family == AF_INET6) &#123;<br><br>        <span class="hljs-keyword">struct</span> sockaddr_in6 *dest_addr_ip6 = (<span class="hljs-keyword">struct</span> sockaddr_in6 *)&amp;dest_addr;<br><br>        bzero(&amp;dest_addr_ip6-&gt;sin6_addr.un, <span class="hljs-keyword">sizeof</span>(dest_addr_ip6-&gt;sin6_addr.un));<br><br>        dest_addr_ip6-&gt;sin6_family = AF_INET6;<br><br>        dest_addr_ip6-&gt;sin6_port = htons(PORT);<br><br>        ip_protocol = IPPROTO_IPV6;<br><br>    &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  <br><br>    <span class="hljs-type">int</span> listen_sock = socket(addr_family, SOCK_STREAM, ip_protocol);<br><br>    <span class="hljs-keyword">if</span> (listen_sock &lt; <span class="hljs-number">0</span>) &#123;<br><br>        ESP_LOGE(TAG, <span class="hljs-string">&quot;Unable to create socket: errno %d&quot;</span>, errno);<br><br>        vTaskDelete(<span class="hljs-literal">NULL</span>);<br><br>        <span class="hljs-keyword">return</span>;<br><br>    &#125;<br><br>    <span class="hljs-type">int</span> opt = <span class="hljs-number">1</span>;<br><br>    setsockopt(listen_sock, SOL_SOCKET, SO_REUSEADDR, &amp;opt, <span class="hljs-keyword">sizeof</span>(opt));<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(CONFIG_EXAMPLE_IPV4) &amp;&amp; defined(CONFIG_EXAMPLE_IPV6)</span><br><br>    <span class="hljs-comment">// Note that by default IPV6 binds to both protocols, it is must be disabled</span><br><br>    <span class="hljs-comment">// if both protocols used at the same time (used in CI)</span><br><br>    setsockopt(listen_sock, IPPROTO_IPV6, IPV6_V6ONLY, &amp;opt, <span class="hljs-keyword">sizeof</span>(opt));<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  <br><br>    ESP_LOGI(TAG, <span class="hljs-string">&quot;Socket created&quot;</span>);<br><br>  <br><br>    <span class="hljs-type">int</span> err = bind(listen_sock, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;dest_addr, <span class="hljs-keyword">sizeof</span>(dest_addr));<br><br>    <span class="hljs-keyword">if</span> (err != <span class="hljs-number">0</span>) &#123;<br><br>        ESP_LOGE(TAG, <span class="hljs-string">&quot;Socket unable to bind: errno %d&quot;</span>, errno);<br><br>        ESP_LOGE(TAG, <span class="hljs-string">&quot;IPPROTO: %d&quot;</span>, addr_family);<br><br>        <span class="hljs-keyword">goto</span> CLEAN_UP;<br><br>    &#125;<br><br>    ESP_LOGI(TAG, <span class="hljs-string">&quot;Socket bound, port %d&quot;</span>, PORT);<br><br>  <br><br>    err = listen(listen_sock, <span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">if</span> (err != <span class="hljs-number">0</span>) &#123;<br><br>        ESP_LOGE(TAG, <span class="hljs-string">&quot;Error occurred during listen: errno %d&quot;</span>, errno);<br><br>        <span class="hljs-keyword">goto</span> CLEAN_UP;<br><br>    &#125;<br><br>  <br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br><br>  <br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;Socket listening&quot;</span>);<br><br>  <br><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_storage</span> <span class="hljs-title">source_addr</span>;</span> <span class="hljs-comment">// Large enough for both IPv4 or IPv6</span><br><br>        <span class="hljs-type">socklen_t</span> addr_len = <span class="hljs-keyword">sizeof</span>(source_addr);<br><br>        <span class="hljs-type">int</span> sock = accept(listen_sock, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;source_addr, &amp;addr_len);<br><br>        <span class="hljs-keyword">if</span> (sock &lt; <span class="hljs-number">0</span>) &#123;<br><br>            ESP_LOGE(TAG, <span class="hljs-string">&quot;Unable to accept connection: errno %d&quot;</span>, errno);<br><br>            <span class="hljs-keyword">break</span>;<br><br>        &#125;<br><br>  <br><br>        <span class="hljs-comment">// Set tcp keepalive option</span><br><br>        setsockopt(sock, SOL_SOCKET, SO_KEEPALIVE, &amp;keepAlive, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br><br>        setsockopt(sock, IPPROTO_TCP, TCP_KEEPIDLE, &amp;keepIdle, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br><br>        setsockopt(sock, IPPROTO_TCP, TCP_KEEPINTVL, &amp;keepInterval, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br><br>        setsockopt(sock, IPPROTO_TCP, TCP_KEEPCNT, &amp;keepCount, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br><br>        <span class="hljs-comment">// Convert ip address to string</span><br><br>        <span class="hljs-keyword">if</span> (source_addr.ss_family == PF_INET) &#123;<br><br>            inet_ntoa_r(((<span class="hljs-keyword">struct</span> sockaddr_in *)&amp;source_addr)-&gt;sin_addr, addr_str, <span class="hljs-keyword">sizeof</span>(addr_str) - <span class="hljs-number">1</span>);<br><br>        &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_EXAMPLE_IPV6</span><br><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (source_addr.ss_family == PF_INET6) &#123;<br><br>            inet6_ntoa_r(((<span class="hljs-keyword">struct</span> sockaddr_in6 *)&amp;source_addr)-&gt;sin6_addr, addr_str, <span class="hljs-keyword">sizeof</span>(addr_str) - <span class="hljs-number">1</span>);<br><br>        &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;Socket accepted ip address: %s&quot;</span>, addr_str);<br><br>  <br><br>        do_retransmit(sock);<br><br>  <br><br>        shutdown(sock, <span class="hljs-number">0</span>);<br><br>        close(sock);<br><br>    &#125;<br><br>  <br><br>CLEAN_UP:<br><br>    close(listen_sock);<br><br>    vTaskDelete(<span class="hljs-literal">NULL</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>值得注意的一点：这里将整个tcpserver的流程放在一个task里，以至于他只能一对一通信，若要连接多个，则需要将连接，接收的部分也作为task来编写。</p>
<h3 id="3-UDP协议"><a href="#3-UDP协议" class="headerlink" title="3. UDP协议"></a>3. UDP协议</h3><h4 id="UDP客户端"><a href="#UDP客户端" class="headerlink" title="UDP客户端"></a>UDP客户端</h4><p>TCP与UDP之间的差异：<br>流程：<br><img src="/2023/06/06/4.%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/ESP32wifi%E5%85%A5%E9%97%A8/img30073951.png" srcset="/img/loading.gif" lazyload><br>特点及应用：<br><img src="/2023/06/06/4.%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/ESP32wifi%E5%85%A5%E9%97%A8/img30074029.png" srcset="/img/loading.gif" lazyload></p>
<p>参考例程：<code>C:\Espressif\frameworks\esp-idf-v4.4.3\examples\protocols\sockets\udp_client</code><br>udp_client_task:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">udp_client_task</span><span class="hljs-params">(<span class="hljs-type">void</span> *pvParameters)</span><br><br>&#123;<br><br>    <span class="hljs-type">char</span> rx_buffer[<span class="hljs-number">128</span>];<br><br>    <span class="hljs-type">char</span> host_ip[] = HOST_IP_ADDR;<br><br>    <span class="hljs-type">int</span> addr_family = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-type">int</span> ip_protocol = <span class="hljs-number">0</span>;<br><br>  <br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br><br>  <br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(CONFIG_EXAMPLE_IPV4)</span><br><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">dest_addr</span>;</span><br><br>        dest_addr.sin_addr.s_addr = inet_addr(HOST_IP_ADDR);<br><br>        dest_addr.sin_family = AF_INET;<br><br>        dest_addr.sin_port = htons(PORT);<br><br>        addr_family = AF_INET;<br><br>        ip_protocol = IPPROTO_IP;<br><br><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(CONFIG_EXAMPLE_IPV6)</span><br><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in6</span> <span class="hljs-title">dest_addr</span> =</span> &#123; <span class="hljs-number">0</span> &#125;;<br><br>        inet6_aton(HOST_IP_ADDR, &amp;dest_addr.sin6_addr);<br><br>        dest_addr.sin6_family = AF_INET6;<br><br>        dest_addr.sin6_port = htons(PORT);<br><br>        dest_addr.sin6_scope_id = esp_netif_get_netif_impl_index(EXAMPLE_INTERFACE);<br><br>        addr_family = AF_INET6;<br><br>        ip_protocol = IPPROTO_IPV6;<br><br><span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(CONFIG_EXAMPLE_SOCKET_IP_INPUT_STDIN)</span><br><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_storage</span> <span class="hljs-title">dest_addr</span> =</span> &#123; <span class="hljs-number">0</span> &#125;;<br><br>        ESP_ERROR_CHECK(get_addr_from_stdin(PORT, SOCK_DGRAM, &amp;ip_protocol, &amp;addr_family, &amp;dest_addr));<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  <br><br>        <span class="hljs-type">int</span> sock = socket(addr_family, SOCK_DGRAM, ip_protocol);<br><br>        <span class="hljs-keyword">if</span> (sock &lt; <span class="hljs-number">0</span>) &#123;<br><br>            ESP_LOGE(TAG, <span class="hljs-string">&quot;Unable to create socket: errno %d&quot;</span>, errno);<br><br>            <span class="hljs-keyword">break</span>;<br><br>        &#125;<br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;Socket created, sending to %s:%d&quot;</span>, HOST_IP_ADDR, PORT);<br><br>  <br><br>        <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br><br>  <br><br>            <span class="hljs-type">int</span> err = sendto(sock, payload, <span class="hljs-built_in">strlen</span>(payload), <span class="hljs-number">0</span>, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;dest_addr, <span class="hljs-keyword">sizeof</span>(dest_addr));<br><br>            <span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>) &#123;<br><br>                ESP_LOGE(TAG, <span class="hljs-string">&quot;Error occurred during sending: errno %d&quot;</span>, errno);<br><br>                <span class="hljs-keyword">break</span>;<br><br>            &#125;<br><br>            ESP_LOGI(TAG, <span class="hljs-string">&quot;Message sent&quot;</span>);<br><br>  <br><br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_storage</span> <span class="hljs-title">source_addr</span>;</span> <span class="hljs-comment">// Large enough for both IPv4 or IPv6</span><br><br>            <span class="hljs-type">socklen_t</span> socklen = <span class="hljs-keyword">sizeof</span>(source_addr);<br><br>            <span class="hljs-type">int</span> len = recvfrom(sock, rx_buffer, <span class="hljs-keyword">sizeof</span>(rx_buffer) - <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;source_addr, &amp;socklen);<br><br>  <br><br>            <span class="hljs-comment">// Error occurred during receiving</span><br><br>            <span class="hljs-keyword">if</span> (len &lt; <span class="hljs-number">0</span>) &#123;<br><br>                ESP_LOGE(TAG, <span class="hljs-string">&quot;recvfrom failed: errno %d&quot;</span>, errno);<br><br>                <span class="hljs-keyword">break</span>;<br><br>            &#125;<br><br>            <span class="hljs-comment">// Data received</span><br><br>            <span class="hljs-keyword">else</span> &#123;<br><br>                rx_buffer[len] = <span class="hljs-number">0</span>; <span class="hljs-comment">// Null-terminate whatever we received and treat like a string</span><br><br>                ESP_LOGI(TAG, <span class="hljs-string">&quot;Received %d bytes from %s:&quot;</span>, len, host_ip);<br><br>                ESP_LOGI(TAG, <span class="hljs-string">&quot;%s&quot;</span>, rx_buffer);<br><br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(rx_buffer, <span class="hljs-string">&quot;OK: &quot;</span>, <span class="hljs-number">4</span>) == <span class="hljs-number">0</span>) &#123;<br><br>                    ESP_LOGI(TAG, <span class="hljs-string">&quot;Received expected message, reconnecting&quot;</span>);<br><br>                    <span class="hljs-keyword">break</span>;<br><br>                &#125;<br><br>            &#125;<br><br>  <br><br>            vTaskDelay(<span class="hljs-number">2000</span> / portTICK_PERIOD_MS);<br><br>        &#125;<br><br>  <br><br>        <span class="hljs-keyword">if</span> (sock != <span class="hljs-number">-1</span>) &#123;<br><br>            ESP_LOGE(TAG, <span class="hljs-string">&quot;Shutting down socket and restarting...&quot;</span>);<br><br>            shutdown(sock, <span class="hljs-number">0</span>);<br><br>            close(sock);<br><br>        &#125;<br><br>    &#125;<br><br>    vTaskDelete(<span class="hljs-literal">NULL</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure>


<h4 id="UDP服务端："><a href="#UDP服务端：" class="headerlink" title="UDP服务端："></a>UDP服务端：</h4><p>参考例程：<code>C:\Espressif\frameworks\esp-idf-v4.4.3\examples\protocols\sockets\udp_server</code><br>udp_server_task:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">udp_server_task</span><span class="hljs-params">(<span class="hljs-type">void</span> *pvParameters)</span><br><br>&#123;<br><br>    <span class="hljs-type">char</span> rx_buffer[<span class="hljs-number">128</span>];<br><br>    <span class="hljs-type">char</span> addr_str[<span class="hljs-number">128</span>];<br><br>    <span class="hljs-type">int</span> addr_family = (<span class="hljs-type">int</span>)pvParameters;<br><br>    <span class="hljs-type">int</span> ip_protocol = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in6</span> <span class="hljs-title">dest_addr</span>;</span><br><br>  <br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br><br>  <br><br>        <span class="hljs-keyword">if</span> (addr_family == AF_INET) &#123;<br><br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> *<span class="hljs-title">dest_addr_ip4</span> =</span> (<span class="hljs-keyword">struct</span> sockaddr_in *)&amp;dest_addr;<br><br>            dest_addr_ip4-&gt;sin_addr.s_addr = htonl(INADDR_ANY);<br><br>            dest_addr_ip4-&gt;sin_family = AF_INET;<br><br>            dest_addr_ip4-&gt;sin_port = htons(PORT);<br><br>            ip_protocol = IPPROTO_IP;<br><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (addr_family == AF_INET6) &#123;<br><br>            bzero(&amp;dest_addr.sin6_addr.un, <span class="hljs-keyword">sizeof</span>(dest_addr.sin6_addr.un));<br><br>            dest_addr.sin6_family = AF_INET6;<br><br>            dest_addr.sin6_port = htons(PORT);<br><br>            ip_protocol = IPPROTO_IPV6;<br><br>        &#125;<br><br>  <br><br>        <span class="hljs-type">int</span> sock = socket(addr_family, SOCK_DGRAM, ip_protocol);<br><br>        <span class="hljs-keyword">if</span> (sock &lt; <span class="hljs-number">0</span>) &#123;<br><br>            ESP_LOGE(TAG, <span class="hljs-string">&quot;Unable to create socket: errno %d&quot;</span>, errno);<br><br>            <span class="hljs-keyword">break</span>;<br><br>        &#125;<br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;Socket created&quot;</span>);<br><br>  <br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(CONFIG_LWIP_NETBUF_RECVINFO) &amp;&amp; !defined(CONFIG_EXAMPLE_IPV6)</span><br><br>        <span class="hljs-type">int</span> enable = <span class="hljs-number">1</span>;<br><br>        lwip_setsockopt(sock, IPPROTO_IP, IP_PKTINFO, &amp;enable, <span class="hljs-keyword">sizeof</span>(enable));<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  <br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(CONFIG_EXAMPLE_IPV4) &amp;&amp; defined(CONFIG_EXAMPLE_IPV6)</span><br><br>        <span class="hljs-keyword">if</span> (addr_family == AF_INET6) &#123;<br><br>            <span class="hljs-comment">// Note that by default IPV6 binds to both protocols, it is must be disabled</span><br><br>            <span class="hljs-comment">// if both protocols used at the same time (used in CI)</span><br><br>            <span class="hljs-type">int</span> opt = <span class="hljs-number">1</span>;<br><br>            setsockopt(sock, SOL_SOCKET, SO_REUSEADDR, &amp;opt, <span class="hljs-keyword">sizeof</span>(opt));<br><br>            setsockopt(sock, IPPROTO_IPV6, IPV6_V6ONLY, &amp;opt, <span class="hljs-keyword">sizeof</span>(opt));<br><br>        &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  <br><br>        <span class="hljs-type">int</span> err = bind(sock, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;dest_addr, <span class="hljs-keyword">sizeof</span>(dest_addr));<br><br>        <span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>) &#123;<br><br>            ESP_LOGE(TAG, <span class="hljs-string">&quot;Socket unable to bind: errno %d&quot;</span>, errno);<br><br>        &#125;<br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;Socket bound, port %d&quot;</span>, PORT);<br><br>  <br><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_storage</span> <span class="hljs-title">source_addr</span>;</span> <span class="hljs-comment">// Large enough for both IPv4 or IPv6</span><br><br>        <span class="hljs-type">socklen_t</span> socklen = <span class="hljs-keyword">sizeof</span>(source_addr);<br><br>  <br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(CONFIG_LWIP_NETBUF_RECVINFO) &amp;&amp; !defined(CONFIG_EXAMPLE_IPV6)</span><br><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iov</span>;</span><br><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msghdr</span> <span class="hljs-title">msg</span>;</span><br><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> *<span class="hljs-title">cmsgtmp</span>;</span><br><br>        <span class="hljs-type">u8_t</span> cmsg_buf[CMSG_SPACE(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> in_pktinfo))];<br><br>  <br><br>        iov.iov_base = rx_buffer;<br><br>        iov.iov_len = <span class="hljs-keyword">sizeof</span>(rx_buffer);<br><br>        msg.msg_control = cmsg_buf;<br><br>        msg.msg_controllen = <span class="hljs-keyword">sizeof</span>(cmsg_buf);<br><br>        msg.msg_flags = <span class="hljs-number">0</span>;<br><br>        msg.msg_iov = &amp;iov;<br><br>        msg.msg_iovlen = <span class="hljs-number">1</span>;<br><br>        msg.msg_name = (<span class="hljs-keyword">struct</span> sockaddr *)&amp;source_addr;<br><br>        msg.msg_namelen = socklen;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  <br><br>        <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br><br>            ESP_LOGI(TAG, <span class="hljs-string">&quot;Waiting for data&quot;</span>);<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(CONFIG_LWIP_NETBUF_RECVINFO) &amp;&amp; !defined(CONFIG_EXAMPLE_IPV6)</span><br><br>            <span class="hljs-type">int</span> len = recvmsg(sock, &amp;msg, <span class="hljs-number">0</span>);<br><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><br>            <span class="hljs-type">int</span> len = recvfrom(sock, rx_buffer, <span class="hljs-keyword">sizeof</span>(rx_buffer) - <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;source_addr, &amp;socklen);<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>            <span class="hljs-comment">// Error occurred during receiving</span><br><br>            <span class="hljs-keyword">if</span> (len &lt; <span class="hljs-number">0</span>) &#123;<br><br>                ESP_LOGE(TAG, <span class="hljs-string">&quot;recvfrom failed: errno %d&quot;</span>, errno);<br><br>                <span class="hljs-keyword">break</span>;<br><br>            &#125;<br><br>            <span class="hljs-comment">// Data received</span><br><br>            <span class="hljs-keyword">else</span> &#123;<br><br>                <span class="hljs-comment">// Get the sender&#x27;s ip address as string</span><br><br>                <span class="hljs-keyword">if</span> (source_addr.ss_family == PF_INET) &#123;<br><br>                    inet_ntoa_r(((<span class="hljs-keyword">struct</span> sockaddr_in *)&amp;source_addr)-&gt;sin_addr, addr_str, <span class="hljs-keyword">sizeof</span>(addr_str) - <span class="hljs-number">1</span>);<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(CONFIG_LWIP_NETBUF_RECVINFO) &amp;&amp; !defined(CONFIG_EXAMPLE_IPV6)</span><br><br>                    <span class="hljs-keyword">for</span> ( cmsgtmp = CMSG_FIRSTHDR(&amp;msg); cmsgtmp != <span class="hljs-literal">NULL</span>; cmsgtmp = CMSG_NXTHDR(&amp;msg, cmsgtmp) ) &#123;<br><br>                        <span class="hljs-keyword">if</span> ( cmsgtmp-&gt;cmsg_level == IPPROTO_IP &amp;&amp; cmsgtmp-&gt;cmsg_type == IP_PKTINFO ) &#123;<br><br>                            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">in_pktinfo</span> *<span class="hljs-title">pktinfo</span>;</span><br><br>                            pktinfo = (<span class="hljs-keyword">struct</span> in_pktinfo*)CMSG_DATA(cmsgtmp);<br><br>                            ESP_LOGI(TAG, <span class="hljs-string">&quot;dest ip: %s\n&quot;</span>, inet_ntoa(pktinfo-&gt;ipi_addr));<br><br>                        &#125;<br><br>                    &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (source_addr.ss_family == PF_INET6) &#123;<br><br>                    inet6_ntoa_r(((<span class="hljs-keyword">struct</span> sockaddr_in6 *)&amp;source_addr)-&gt;sin6_addr, addr_str, <span class="hljs-keyword">sizeof</span>(addr_str) - <span class="hljs-number">1</span>);<br><br>                &#125;<br><br>  <br><br>                rx_buffer[len] = <span class="hljs-number">0</span>; <span class="hljs-comment">// Null-terminate whatever we received and treat like a string...</span><br><br>                ESP_LOGI(TAG, <span class="hljs-string">&quot;Received %d bytes from %s:&quot;</span>, len, addr_str);<br><br>                ESP_LOGI(TAG, <span class="hljs-string">&quot;%s&quot;</span>, rx_buffer);<br><br>  <br><br>                <span class="hljs-type">int</span> err = sendto(sock, rx_buffer, len, <span class="hljs-number">0</span>, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;source_addr, <span class="hljs-keyword">sizeof</span>(source_addr));<br><br>                <span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>) &#123;<br><br>                    ESP_LOGE(TAG, <span class="hljs-string">&quot;Error occurred during sending: errno %d&quot;</span>, errno);<br><br>                    <span class="hljs-keyword">break</span>;<br><br>                &#125;<br><br>            &#125;<br><br>        &#125;<br><br>  <br><br>        <span class="hljs-keyword">if</span> (sock != <span class="hljs-number">-1</span>) &#123;<br><br>            ESP_LOGE(TAG, <span class="hljs-string">&quot;Shutting down socket and restarting...&quot;</span>);<br><br>            shutdown(sock, <span class="hljs-number">0</span>);<br><br>            close(sock);<br><br>        &#125;<br><br>    &#125;<br><br>    vTaskDelete(<span class="hljs-literal">NULL</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="4-HTTP协议"><a href="#4-HTTP协议" class="headerlink" title="4.HTTP协议"></a>4.HTTP协议</h3><h4 id="HTTP介绍："><a href="#HTTP介绍：" class="headerlink" title="HTTP介绍："></a>HTTP介绍：</h4><p>HTTP（HyperText Transfer Protocol）是用于传输Web数据的应用层协议，它是基于TCP&#x2F;IP协议栈之上的。HTTP协议的作用是规定客户端和服务器之间通讯的格式和内容，确保客户端能够正确向服务器请求数据，服务器也能够正确地响应请求并返回数据。</p>
<p>HTTP协议使用客户端&#x2F;服务器模型。客户端向服务器发送HTTP请求，服务器接收到请求后，根据请求的内容进行一定的处理，并将处理结果封装在HTTP响应中返回给客户端。HTTP请求和响应都有一定的结构，通常包含三部分：起始行、首部和主体。</p>
<p><img src="/2023/06/06/4.%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/ESP32wifi%E5%85%A5%E9%97%A8/img30084556.png" srcset="/img/loading.gif" lazyload><br><img src="/2023/06/06/4.%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/ESP32wifi%E5%85%A5%E9%97%A8/img30084739.png" srcset="/img/loading.gif" lazyload><br>HTTP的起始行包含了请求方法或响应状态码等信息，如GET、POST等请求方法，200 OK、404 Not Found等响应状态码。HTTP的首部包含了请求或响应的各项属性，如Accept、Content-Type、Set-Cookie等。HTTP的主体则包含了请求或响应的具体内容，如HTML、JSON等文本数据或二进制数据。<br>请求：<br><img src="/2023/06/06/4.%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/ESP32wifi%E5%85%A5%E9%97%A8/img30084807.png" srcset="/img/loading.gif" lazyload><br>响应：<br><img src="/2023/06/06/4.%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/ESP32wifi%E5%85%A5%E9%97%A8/img30085006.png" srcset="/img/loading.gif" lazyload><br><img src="/2023/06/06/4.%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/ESP32wifi%E5%85%A5%E9%97%A8/img30085057.png" srcset="/img/loading.gif" lazyload><br>HTTP协议也具有无状态性，即服务器不会保存客户端的任何状态信息，每个请求都是独立的，需要客户端通过某种方式将状态信息发送给服务器，如Cookie机制。</p>
<p>目前主流的HTTP版本为HTTP&#x2F;1.1和HTTP&#x2F;2，其中HTTP&#x2F;1.1采用串行的方式发送和接收数据，而HTTP&#x2F;2支持多路复用，可以同时发送多个请求和响应，性能更好。</p>
<h4 id="URL格式："><a href="#URL格式：" class="headerlink" title="URL格式："></a>URL格式：</h4><p>URL（Uniform Resource Locator）是用于定位互联网上资源的地址，常见的资源包括网页、图片、视频等。URL由多个部分组成，包括协议、主机名、端口号、路径和查询字符串等。</p>
<p>一个标准的URL格式如下：</p>
<p>复制代码</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">协议</span>&gt;</span>://<span class="hljs-tag">&lt;<span class="hljs-name">主机名</span>&gt;</span>:<span class="hljs-tag">&lt;<span class="hljs-name">端口</span>&gt;</span>/<span class="hljs-tag">&lt;<span class="hljs-name">路径</span>&gt;</span>?<span class="hljs-tag">&lt;<span class="hljs-name">查询字符串</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>其中，协议表示访问资源所采用的协议，如HTTP、HTTPS、FTP等；主机名表示资源所在的主机名或IP地址；端口号表示与主机通信的端口号，默认情况下使用协议默认的端口；路径表示请求的资源路径，可以是一个具体的文件路径，也可以是一个文件夹路径；查询字符串表示请求参数，以问号（?）开头，多个参数之间用&amp;符号分隔。</p>
<p>例如，以下是一个标准的URL格式：</p>
<p>复制代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://www.example.com:80/index.html?<span class="hljs-built_in">id</span>=123&amp;name=<span class="hljs-built_in">test</span><br></code></pre></td></tr></table></figure>

<p>其中，协议为HTTPS，<a target="_blank" rel="noopener" href="http://主机名为www.example.com/">主机名为www.example.com</a>，端口号为80（默认端口号可省略），路径为&#x2F;index.html，查询字符串为id&#x3D;123&amp;name&#x3D;test。</p>
<h4 id="请求方法（以http-server为例）："><a href="#请求方法（以http-server为例）：" class="headerlink" title="请求方法（以http-server为例）："></a>请求方法（以http-server为例）：</h4><p>示例代码：<code>C:\Espressif\frameworks\esp-idf-v4.4.3\examples\protocols\http_server\simple</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">httpd_handle_t</span> <span class="hljs-title function_">start_webserver</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br><br>&#123;<br><br>    <span class="hljs-type">httpd_handle_t</span> server = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-type">httpd_config_t</span> config = HTTPD_DEFAULT_CONFIG();<br><br>    config.lru_purge_enable = <span class="hljs-literal">true</span>;<br><br>  <br><br>    <span class="hljs-comment">// Start the httpd server</span><br><br>    ESP_LOGI(TAG, <span class="hljs-string">&quot;Starting server on port: &#x27;%d&#x27;&quot;</span>, config.server_port);<br><br>    <span class="hljs-keyword">if</span> (httpd_start(&amp;server, &amp;config) == ESP_OK) &#123;<br><br>        <span class="hljs-comment">// Set URI handlers</span><br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;Registering URI handlers&quot;</span>);<br><br>        httpd_register_uri_handler(server, &amp;hello);<br><br>        httpd_register_uri_handler(server, &amp;echo);<br><br>        httpd_register_uri_handler(server, &amp;ctrl);<br><br>        <span class="hljs-meta">#<span class="hljs-keyword">if</span> CONFIG_EXAMPLE_BASIC_AUTH</span><br><br>        httpd_register_basic_auth(server);<br><br>        <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>        <span class="hljs-keyword">return</span> server;<br><br>    &#125;<br><br>  <br><br>    ESP_LOGI(TAG, <span class="hljs-string">&quot;Error starting server!&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<p>这段代码是一个基于ESP32的HTTP服务器程序，通过调用httpd_start()函数启动HTTP服务器，并注册URI处理函数，来实现Web服务的功能。主要包括以下几个步骤：</p>
<ol>
<li><p>初始化HTTPD配置，使用HTTPD_DEFAULT_CONFIG()函数可以获得默认的HTTPD配置对象，这里设置了LRU清理使能；</p>
</li>
<li><p>启动HTTPD服务器，通过调用httpd_start()函数启动HTTPD服务器，参数server指向创建后的HTTPD句柄，config包含HTTPD的配置信息；</p>
</li>
<li><p>注册URI处理函数，通过调用httpd_register_uri_handler()函数将URI处理函数添加到HTTP服务器的URI处理列表中，可以实现不同URI地址的访问和处理；</p>
</li>
<li><p>注册基本认证机制，如果开启了CONFIG_EXAMPLE_BASIC_AUTH宏定义，则通过httpd_register_basic_auth()函数在HTTPD服务器上注册基本的用户名密码验证机制。</p>
</li>
</ol>
<p>这里的hello、echo、ctrl都是处理URI请求的处理函数，分别对应不同的URI地址。httpd_handle_t类型是HTTPD服务器的句柄类型，可以用于维护HTTPD服务器的状态等信息.</p>
<p>下面对这几个处理函数进行分析：</p>
<h5 id="get方法"><a href="#get方法" class="headerlink" title="get方法"></a>get方法</h5><p>注册路由：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">httpd_uri_t</span> hello = &#123;<br><br>    .uri       = <span class="hljs-string">&quot;/hello&quot;</span>,<br><br>    .method    = HTTP_GET,<br><br>    .handler   = hello_get_handler,<br><br>    <span class="hljs-comment">/* Let&#x27;s pass response string in user</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">     * context to demonstrate it&#x27;s usage */</span><br><br>    .user_ctx  = <span class="hljs-string">&quot;Hello World!&quot;</span><br><br>&#125;;<br></code></pre></td></tr></table></figure>
<p>这段代码是一个基于ESP32的HTTP服务器程序中的URI处理函数，对应的URI地址为&#x2F;hello。具体来说：</p>
<ol>
<li><p>.uri表示了要处理的URI地址，即当客户端请求该地址时，调用相应的处理函数进行处理；</p>
</li>
<li><p>.method表示了该URI地址所支持的HTTP请求方法，本例中为HTTP_GET，即只支持GET请求；</p>
</li>
<li><p>.handler表示了处理函数，当客户端发起请求时，调用该处理函数进行响应；</p>
</li>
<li><p>.user_ctx是一个指向用户数据的指针，允许在处理函数中使用该指针来存储一些用户自定义的数据，这里将”Hello World!”传递给处理函数作为响应内容。</p>
</li>
</ol>
<p>在这个例子中，当客户端通过GET方法请求URI地址&#x2F;hello时，会调用hello_get_handler函数进行处理，函数的实现可以根据需求自行编写。</p>
<p>下面是处理函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">esp_err_t</span> <span class="hljs-title function_">hello_get_handler</span><span class="hljs-params">(<span class="hljs-type">httpd_req_t</span> *req)</span><br><br>&#123;<br><br>    <span class="hljs-type">char</span>*  buf;<br><br>    <span class="hljs-type">size_t</span> buf_len;<br><br>  <br><br>    <span class="hljs-comment">/* Get header value string length and allocate memory for length + 1,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">     * extra byte for null termination */</span><br><br>    buf_len = httpd_req_get_hdr_value_len(req, <span class="hljs-string">&quot;Host&quot;</span>) + <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">if</span> (buf_len &gt; <span class="hljs-number">1</span>) &#123;<br><br>        buf = <span class="hljs-built_in">malloc</span>(buf_len);<br><br>        <span class="hljs-comment">/* Copy null terminated value string into buffer */</span><br><br>        <span class="hljs-keyword">if</span> (httpd_req_get_hdr_value_str(req, <span class="hljs-string">&quot;Host&quot;</span>, buf, buf_len) == ESP_OK) &#123;<br><br>            ESP_LOGI(TAG, <span class="hljs-string">&quot;Found header =&gt; Host: %s&quot;</span>, buf);<br><br>        &#125;<br><br>        <span class="hljs-built_in">free</span>(buf);<br><br>    &#125;<br><br>  <br><br>    buf_len = httpd_req_get_hdr_value_len(req, <span class="hljs-string">&quot;Test-Header-2&quot;</span>) + <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">if</span> (buf_len &gt; <span class="hljs-number">1</span>) &#123;<br><br>        buf = <span class="hljs-built_in">malloc</span>(buf_len);<br><br>        <span class="hljs-keyword">if</span> (httpd_req_get_hdr_value_str(req, <span class="hljs-string">&quot;Test-Header-2&quot;</span>, buf, buf_len) == ESP_OK) &#123;<br><br>            ESP_LOGI(TAG, <span class="hljs-string">&quot;Found header =&gt; Test-Header-2: %s&quot;</span>, buf);<br><br>        &#125;<br><br>        <span class="hljs-built_in">free</span>(buf);<br><br>    &#125;<br><br>  <br><br>    buf_len = httpd_req_get_hdr_value_len(req, <span class="hljs-string">&quot;Test-Header-1&quot;</span>) + <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">if</span> (buf_len &gt; <span class="hljs-number">1</span>) &#123;<br><br>        buf = <span class="hljs-built_in">malloc</span>(buf_len);<br><br>        <span class="hljs-keyword">if</span> (httpd_req_get_hdr_value_str(req, <span class="hljs-string">&quot;Test-Header-1&quot;</span>, buf, buf_len) == ESP_OK) &#123;<br><br>            ESP_LOGI(TAG, <span class="hljs-string">&quot;Found header =&gt; Test-Header-1: %s&quot;</span>, buf);<br><br>        &#125;<br><br>        <span class="hljs-built_in">free</span>(buf);<br><br>    &#125;<br><br>  <br><br>    <span class="hljs-comment">/* Read URL query string length and allocate memory for length + 1,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">     * extra byte for null termination */</span><br><br>    buf_len = httpd_req_get_url_query_len(req) + <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">if</span> (buf_len &gt; <span class="hljs-number">1</span>) &#123;<br><br>        buf = <span class="hljs-built_in">malloc</span>(buf_len);<br><br>        <span class="hljs-keyword">if</span> (httpd_req_get_url_query_str(req, buf, buf_len) == ESP_OK) &#123;<br><br>            ESP_LOGI(TAG, <span class="hljs-string">&quot;Found URL query =&gt; %s&quot;</span>, buf);<br><br>            <span class="hljs-type">char</span> param[<span class="hljs-number">32</span>];<br><br>            <span class="hljs-comment">/* Get value of expected key from query string */</span><br><br>            <span class="hljs-keyword">if</span> (httpd_query_key_value(buf, <span class="hljs-string">&quot;query1&quot;</span>, param, <span class="hljs-keyword">sizeof</span>(param)) == ESP_OK) &#123;<br><br>                ESP_LOGI(TAG, <span class="hljs-string">&quot;Found URL query parameter =&gt; query1=%s&quot;</span>, param);<br><br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (httpd_query_key_value(buf, <span class="hljs-string">&quot;query3&quot;</span>, param, <span class="hljs-keyword">sizeof</span>(param)) == ESP_OK) &#123;<br><br>                ESP_LOGI(TAG, <span class="hljs-string">&quot;Found URL query parameter =&gt; query3=%s&quot;</span>, param);<br><br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (httpd_query_key_value(buf, <span class="hljs-string">&quot;query2&quot;</span>, param, <span class="hljs-keyword">sizeof</span>(param)) == ESP_OK) &#123;<br><br>                ESP_LOGI(TAG, <span class="hljs-string">&quot;Found URL query parameter =&gt; query2=%s&quot;</span>, param);<br><br>            &#125;<br><br>        &#125;<br><br>        <span class="hljs-built_in">free</span>(buf);<br><br>    &#125;<br><br>  <br><br>    <span class="hljs-comment">/* Set some custom headers */</span><br><br>    httpd_resp_set_hdr(req, <span class="hljs-string">&quot;Custom-Header-1&quot;</span>, <span class="hljs-string">&quot;Custom-Value-1&quot;</span>);<br><br>    httpd_resp_set_hdr(req, <span class="hljs-string">&quot;Custom-Header-2&quot;</span>, <span class="hljs-string">&quot;Custom-Value-2&quot;</span>);<br><br>  <br><br>    <span class="hljs-comment">/* Send response with custom headers and body set as the</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">     * string passed in user context*/</span><br><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* resp_str = (<span class="hljs-type">const</span> <span class="hljs-type">char</span>*) req-&gt;user_ctx;<br><br>    httpd_resp_send(req, resp_str, HTTPD_RESP_USE_STRLEN);<br><br>  <br><br>    <span class="hljs-comment">/* After sending the HTTP response the old HTTP request</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">     * headers are lost. Check if HTTP request headers can be read now. */</span><br><br>    <span class="hljs-keyword">if</span> (httpd_req_get_hdr_value_len(req, <span class="hljs-string">&quot;Host&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;Request headers lost&quot;</span>);<br><br>    &#125;<br>    <span class="hljs-keyword">return</span> ESP_OK;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这段代码是一个基于ESP32的HTTP服务器程序中的处理GET请求的函数，对应的URI地址为&#x2F;hello。具体来说：</p>
<ol>
<li><p>首先定义了一个名为hello_get_handler的函数，该函数接收一个指向httpd_req_t类型的指针参数req，表示HTTP请求的结构体实例；</p>
</li>
<li><p>函数中通过httpd_req_get_hdr_value_len和httpd_req_get_hdr_value_str等函数获取HTTP请求头中特定字段的值，比如Host、Test-Header-1、Test-Header-2等；</p>
</li>
<li><p>接着通过httpd_req_get_url_query_len和httpd_req_get_url_query_str等函数获取URL查询字符串，并从中解析出特定键值对的值，比如query1、query2、query3等；</p>
</li>
<li><p>通过httpd_resp_set_hdr设置一些自定义的响应头；</p>
</li>
<li><p>最后调用httpd_resp_send发送HTTP响应，响应内容为req-&gt;user_ctx所指向的字符串，即在URI处理函数中传入的”Hello World!”。</p>
</li>
</ol>
<h5 id="post方法"><a href="#post方法" class="headerlink" title="post方法"></a>post方法</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">httpd_uri_t</span> echo = &#123;<br><br>    .uri       = <span class="hljs-string">&quot;/echo&quot;</span>,<br><br>    .method    = HTTP_POST,<br><br>    .handler   = echo_post_handler,<br><br>    .user_ctx  = <span class="hljs-literal">NULL</span><br><br>&#125;;<br><br></code></pre></td></tr></table></figure>
<p>处理函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* An HTTP POST handler */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">esp_err_t</span> <span class="hljs-title function_">echo_post_handler</span><span class="hljs-params">(<span class="hljs-type">httpd_req_t</span> *req)</span><br><br>&#123;<br><br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">100</span>];<br><br>    <span class="hljs-type">int</span> ret, remaining = req-&gt;content_len;<br><br>  <br><br>    <span class="hljs-keyword">while</span> (remaining &gt; <span class="hljs-number">0</span>) &#123;<br><br>        <span class="hljs-comment">/* Read the data for the request */</span><br><br>        <span class="hljs-keyword">if</span> ((ret = httpd_req_recv(req, buf,<br><br>                        MIN(remaining, <span class="hljs-keyword">sizeof</span>(buf)))) &lt;= <span class="hljs-number">0</span>) &#123;<br><br>            <span class="hljs-keyword">if</span> (ret == HTTPD_SOCK_ERR_TIMEOUT) &#123;<br><br>                <span class="hljs-comment">/* Retry receiving if timeout occurred */</span><br><br>                <span class="hljs-keyword">continue</span>;<br><br>            &#125;<br><br>            <span class="hljs-keyword">return</span> ESP_FAIL;<br><br>        &#125;<br><br>  <br><br>        <span class="hljs-comment">/* Send back the same data */</span><br><br>        httpd_resp_send_chunk(req, buf, ret);<br><br>        remaining -= ret;<br><br>  <br><br>        <span class="hljs-comment">/* Log data received */</span><br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;=========== RECEIVED DATA ==========&quot;</span>);<br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;%.*s&quot;</span>, ret, buf);<br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;====================================&quot;</span>);<br><br>    &#125;<br><br>  <br><br>    <span class="hljs-comment">// End response</span><br><br>    httpd_resp_send_chunk(req, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> ESP_OK;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h5 id="put方法："><a href="#put方法：" class="headerlink" title="put方法："></a>put方法：</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">httpd_uri_t</span> ctrl = &#123;<br><br>    .uri       = <span class="hljs-string">&quot;/ctrl&quot;</span>,<br><br>    .method    = HTTP_PUT,<br><br>    .handler   = ctrl_put_handler,<br><br>    .user_ctx  = <span class="hljs-literal">NULL</span><br><br>&#125;;<br></code></pre></td></tr></table></figure>
<p>处理：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* An HTTP PUT handler. This demonstrates realtime</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> * registration and deregistration of URI handlers</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">esp_err_t</span> <span class="hljs-title function_">ctrl_put_handler</span><span class="hljs-params">(<span class="hljs-type">httpd_req_t</span> *req)</span><br><br>&#123;<br><br>    <span class="hljs-type">char</span> buf;<br><br>    <span class="hljs-type">int</span> ret;<br><br>  <br><br>    <span class="hljs-keyword">if</span> ((ret = httpd_req_recv(req, &amp;buf, <span class="hljs-number">1</span>)) &lt;= <span class="hljs-number">0</span>) &#123;<br><br>        <span class="hljs-keyword">if</span> (ret == HTTPD_SOCK_ERR_TIMEOUT) &#123;<br><br>            httpd_resp_send_408(req);<br><br>        &#125;<br><br>        <span class="hljs-keyword">return</span> ESP_FAIL;<br><br>    &#125;<br><br>  <br><br>    <span class="hljs-keyword">if</span> (buf == <span class="hljs-string">&#x27;0&#x27;</span>) &#123;<br><br>        <span class="hljs-comment">/* URI handlers can be unregistered using the uri string */</span><br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;Unregistering /hello and /echo URIs&quot;</span>);<br><br>        httpd_unregister_uri(req-&gt;handle, <span class="hljs-string">&quot;/hello&quot;</span>);<br><br>        httpd_unregister_uri(req-&gt;handle, <span class="hljs-string">&quot;/echo&quot;</span>);<br><br>        <span class="hljs-comment">/* Register the custom error handler */</span><br><br>        httpd_register_err_handler(req-&gt;handle, HTTPD_404_NOT_FOUND, http_404_error_handler);<br><br>    &#125;<br><br>    <span class="hljs-keyword">else</span> &#123;<br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;Registering /hello and /echo URIs&quot;</span>);<br><br>        httpd_register_uri_handler(req-&gt;handle, &amp;hello);<br><br>        httpd_register_uri_handler(req-&gt;handle, &amp;echo);<br><br>        <span class="hljs-comment">/* Unregister custom error handler */</span><br><br>        httpd_register_err_handler(req-&gt;handle, HTTPD_404_NOT_FOUND, <span class="hljs-literal">NULL</span>);<br><br>    &#125;<br><br>  <br><br>    <span class="hljs-comment">/* Respond with empty body */</span><br><br>    httpd_resp_send(req, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">return</span> ESP_OK;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>这段代码是一个HTTP PUT请求处理函数，主要用于实现URI处理器（URI handlers）的实时注册和注销。具体来说：</p>
<ol>
<li>首先接收HTTP请求的数据并存储到buf中；</li>
<li>判断buf的值是否为’0’，如果是则调用httpd_unregister_uri函数注销&#x2F;hello和&#x2F;echo的URI处理器，同时调用httpd_register_err_handler函数注册了一个自定义的404错误处理函数http_404_error_handler；如果不是则通过httpd_register_uri_handler函数分别注册&#x2F;hello和&#x2F;echo的URI处理器，并取消注册自定义的404错误处理函数；</li>
<li>最后通过httpd_resp_send函数回复空的响应消息体。</li>
</ol>
<p>总之，该函数可实现URI处理器的实时注册和注销，提高了HTTP请求处理的灵活性和可扩展性。</p>
<h4 id="request请求（客户端）"><a href="#request请求（客户端）" class="headerlink" title="request请求（客户端）"></a>request请求（客户端）</h4><p>示例代码：<code>C:\Espressif\frameworks\esp-idf-v4.4.3\examples\protocols\http_request</code><br>http_get_task:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Constants that aren&#x27;t configurable in menuconfig */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> WEB_SERVER <span class="hljs-string">&quot;example.com&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> WEB_PORT <span class="hljs-string">&quot;80&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> WEB_PATH <span class="hljs-string">&quot;/&quot;</span></span><br><br>  <br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *TAG = <span class="hljs-string">&quot;example&quot;</span>;<br><br>  <br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *REQUEST = <span class="hljs-string">&quot;GET &quot;</span> WEB_PATH <span class="hljs-string">&quot; HTTP/1.0\r\n&quot;</span><br><br>    <span class="hljs-string">&quot;Host: &quot;</span>WEB_SERVER<span class="hljs-string">&quot;:&quot;</span>WEB_PORT<span class="hljs-string">&quot;\r\n&quot;</span><br><br>    <span class="hljs-string">&quot;User-Agent: esp-idf/1.0 esp32\r\n&quot;</span><br><br>    <span class="hljs-string">&quot;\r\n&quot;</span>;<br><br>  <br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">http_get_task</span><span class="hljs-params">(<span class="hljs-type">void</span> *pvParameters)</span><br><br>&#123;<br><br>    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">addrinfo</span> <span class="hljs-title">hints</span> =</span> &#123;<br><br>        .ai_family = AF_INET,<br><br>        .ai_socktype = SOCK_STREAM,<br><br>    &#125;;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">addrinfo</span> *<span class="hljs-title">res</span>;</span><br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">in_addr</span> *<span class="hljs-title">addr</span>;</span><br><br>    <span class="hljs-type">int</span> s, r;<br><br>    <span class="hljs-type">char</span> recv_buf[<span class="hljs-number">64</span>];<br><br>  <br><br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) &#123;<br><br>        <span class="hljs-type">int</span> err = getaddrinfo(WEB_SERVER, WEB_PORT, &amp;hints, &amp;res);<br><br>  <br><br>        <span class="hljs-keyword">if</span>(err != <span class="hljs-number">0</span> || res == <span class="hljs-literal">NULL</span>) &#123;<br><br>            ESP_LOGE(TAG, <span class="hljs-string">&quot;DNS lookup failed err=%d res=%p&quot;</span>, err, res);<br><br>            vTaskDelay(<span class="hljs-number">1000</span> / portTICK_PERIOD_MS);<br><br>            <span class="hljs-keyword">continue</span>;<br><br>        &#125;<br><br>  <br><br>        <span class="hljs-comment">/* Code to print the resolved IP.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">           Note: inet_ntoa is non-reentrant, look at ipaddr_ntoa_r for &quot;real&quot; code */</span><br><br>        addr = &amp;((<span class="hljs-keyword">struct</span> sockaddr_in *)res-&gt;ai_addr)-&gt;sin_addr;<br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;DNS lookup succeeded. IP=%s&quot;</span>, inet_ntoa(*addr));<br><br>  <br><br>        s = socket(res-&gt;ai_family, res-&gt;ai_socktype, <span class="hljs-number">0</span>);<br><br>        <span class="hljs-keyword">if</span>(s &lt; <span class="hljs-number">0</span>) &#123;<br><br>            ESP_LOGE(TAG, <span class="hljs-string">&quot;... Failed to allocate socket.&quot;</span>);<br><br>            freeaddrinfo(res);<br><br>            vTaskDelay(<span class="hljs-number">1000</span> / portTICK_PERIOD_MS);<br><br>            <span class="hljs-keyword">continue</span>;<br><br>        &#125;<br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;... allocated socket&quot;</span>);<br><br>  <br><br>        <span class="hljs-keyword">if</span>(connect(s, res-&gt;ai_addr, res-&gt;ai_addrlen) != <span class="hljs-number">0</span>) &#123;<br><br>            ESP_LOGE(TAG, <span class="hljs-string">&quot;... socket connect failed errno=%d&quot;</span>, errno);<br><br>            close(s);<br><br>            freeaddrinfo(res);<br><br>            vTaskDelay(<span class="hljs-number">4000</span> / portTICK_PERIOD_MS);<br><br>            <span class="hljs-keyword">continue</span>;<br><br>        &#125;<br><br>  <br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;... connected&quot;</span>);<br><br>        freeaddrinfo(res);<br><br>  <br><br>        <span class="hljs-keyword">if</span> (write(s, REQUEST, <span class="hljs-built_in">strlen</span>(REQUEST)) &lt; <span class="hljs-number">0</span>) &#123;<br><br>            ESP_LOGE(TAG, <span class="hljs-string">&quot;... socket send failed&quot;</span>);<br><br>            close(s);<br><br>            vTaskDelay(<span class="hljs-number">4000</span> / portTICK_PERIOD_MS);<br><br>            <span class="hljs-keyword">continue</span>;<br><br>        &#125;<br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;... socket send success&quot;</span>);<br><br>  <br><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timeval</span> <span class="hljs-title">receiving_timeout</span>;</span><br><br>        receiving_timeout.tv_sec = <span class="hljs-number">5</span>;<br><br>        receiving_timeout.tv_usec = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-keyword">if</span> (setsockopt(s, SOL_SOCKET, SO_RCVTIMEO, &amp;receiving_timeout,<br><br>                <span class="hljs-keyword">sizeof</span>(receiving_timeout)) &lt; <span class="hljs-number">0</span>) &#123;<br><br>            ESP_LOGE(TAG, <span class="hljs-string">&quot;... failed to set socket receiving timeout&quot;</span>);<br><br>            close(s);<br><br>            vTaskDelay(<span class="hljs-number">4000</span> / portTICK_PERIOD_MS);<br><br>            <span class="hljs-keyword">continue</span>;<br><br>        &#125;<br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;... set socket receiving timeout success&quot;</span>);<br><br>  <br><br>        <span class="hljs-comment">/* Read HTTP response */</span><br><br>        <span class="hljs-keyword">do</span> &#123;<br><br>            bzero(recv_buf, <span class="hljs-keyword">sizeof</span>(recv_buf));<br><br>            r = read(s, recv_buf, <span class="hljs-keyword">sizeof</span>(recv_buf)<span class="hljs-number">-1</span>);<br><br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; r; i++) &#123;<br><br>                <span class="hljs-built_in">putchar</span>(recv_buf[i]);<br><br>            &#125;<br><br>        &#125; <span class="hljs-keyword">while</span>(r &gt; <span class="hljs-number">0</span>);<br><br>  <br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;... done reading from socket. Last read return=%d errno=%d.&quot;</span>, r, errno);<br><br>        close(s);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> countdown = <span class="hljs-number">10</span>; countdown &gt;= <span class="hljs-number">0</span>; countdown--) &#123;<br><br>            ESP_LOGI(TAG, <span class="hljs-string">&quot;%d... &quot;</span>, countdown);<br><br>            vTaskDelay(<span class="hljs-number">1000</span> / portTICK_PERIOD_MS);<br><br>        &#125;<br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;Starting again!&quot;</span>);<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>这是一段 ESP32 上进行 HTTP GET 请求的代码。主要实现了：</p>
<ol>
<li>定义了 WEB_SERVER、WEB_PORT 和 WEB_PATH 三个常量，分别表示服务器地址、端口号和请求路径。</li>
<li>使用 getaddrinfo 函数查询服务器的 IP 地址，并对返回值进行判断处理。</li>
<li>创建一个套接字，并通过 connect 函数连接服务器。</li>
<li>将 HTTP GET 请求通过 write 函数发送给服务器。</li>
<li>设置接收超时时间并通过 read 函数接收服务器的响应报文，将其逐个字符地打印到控制台上。</li>
<li>关闭套接字并延时一段时间后重复执行上述流程。</li>
</ol>
<p>整个过程中使用了一些 ESP32 系统提供的函数和数据结构，如结构体 addrinfo、宏定义 AF_INET 和 SOCK_STREAM、函数 socket、close、read、write、getaddrinfo、freeaddrinfo、setsockopt 等。通过这些函数的调用，可以实现与远程服务器的通信，完成不同的网络应用。</p>
<h3 id="5-webSocket协议"><a href="#5-webSocket协议" class="headerlink" title="5.webSocket协议"></a>5.webSocket协议</h3><h4 id="webSocket介绍"><a href="#webSocket介绍" class="headerlink" title="webSocket介绍"></a>webSocket介绍</h4><p>WebSocket 是一种在单个 TCP 连接上进行全双工通信的协议。它的主要特点是可以实现实时双向通信，并且可以在客户端和服务器之间传输任意数据，而不受 HTTP 语义限制。<br><img src="/2023/06/06/4.%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/ESP32wifi%E5%85%A5%E9%97%A8/img30100750.png" srcset="/img/loading.gif" lazyload></p>
<p>与传统的 HTTP 请求-响应模式不同，WebSocket 采用了类似握手的方法来建立连接。客户端向服务器发送一个 HTTP 请求头，其中包含 Upgrade、Connection、Sec-WebSocket-Key 等字段，通知服务器要进行连接升级。服务器返回一个 HTTP 响应头，其中也包含 Upgrade、Connection 和 Sec-WebSocket-Accept 等字段，表示已同意升级连接。之后，客户端和服务器之间的数据就可以以帧为单位进行传输，每个帧包含一个信息片段，可以是文本也可以是二进制。<br><img src="/2023/06/06/4.%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/ESP32wifi%E5%85%A5%E9%97%A8/img30100636.png" srcset="/img/loading.gif" lazyload><br>WebSocket 协议的优点是支持实时通信，具有较低的延迟，可减少网络传输的开销，有助于提高应用程序的性能。常见的应用场景包括聊天应用、在线游戏、实时数据监控等。</p>
<h4 id="webSocket数据帧格式"><a href="#webSocket数据帧格式" class="headerlink" title="webSocket数据帧格式"></a>webSocket数据帧格式</h4><p>WebSocket 数据帧是 WebSocket 协议中传输数据的基本单位，每个帧可以包含一个或多个信息片段（Message Fragment），可以是文本也可以是二进制，由 Header 和 Payload 两部分组成。<br><img src="/2023/06/06/4.%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/ESP32wifi%E5%85%A5%E9%97%A8/img30101356.png" srcset="/img/loading.gif" lazyload><br>Header 一般包括了以下几个字段：</p>
<ol>
<li>FIN：1 位，表示当前帧是否为消息的最后一帧，值为 1 表示是，值为 0 表示不是。</li>
<li>RSV1、RSV2、RSV3：各占 1 位，用于扩展协议。通常情况下，这三位都被置为 0。</li>
<li>Opcode：4 位，用于表示消息类型，如 0x1 表示文本消息，0x2 表示二进制消息，0x8 表示关闭连接等。</li>
<li>Mask：1 位，表示负载数据是否被掩码处理过，值为 1 表示被掩码处理，值为 0 表示未被掩码处理。</li>
<li>Payload length：7 位或 7+16 位或 7+64 位，表示负载数据的长度。当值为 0~126 时，表示负载数据的长度就是该值；当值为 127 时，额外有两个字节表示长度，当值大于等于 2^16 时，额外有 4 个字节表示长度。<br>如果 Mask 位被设置为 1，则 Header 中还要包含一个 4 字节的掩码码值（Masking Key），用于对负载数据进行反掩码操作。<br>Payload 是实际的数据内容，长度由 Header 中的 Payload length 字段表示，可能是文本也可能是二进制。<br>在整个 WebSocket 连接过程中，客户端和服务器会相互发送一些数据帧，包括握手请求、握手响应、消息片段等，根据不同的功能要求分别使用不同的 Opcode 来表示。</li>
</ol>
<h4 id="webSocket服务器"><a href="#webSocket服务器" class="headerlink" title="webSocket服务器"></a>webSocket服务器</h4><p>示例代码<code>C:\Espressif\frameworks\esp-idf-v4.4.3\examples\protocols\http_server\ws_echo_server</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">esp_err_t</span> <span class="hljs-title function_">echo_handler</span><span class="hljs-params">(<span class="hljs-type">httpd_req_t</span> *req)</span><br><br>&#123;<br><br>    <span class="hljs-keyword">if</span> (req-&gt;method == HTTP_GET) &#123;<br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;Handshake done, the new connection was opened&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> ESP_OK;<br><br>    &#125;<br><br>    <span class="hljs-type">httpd_ws_frame_t</span> ws_pkt;<br><br>    <span class="hljs-type">uint8_t</span> *buf = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-built_in">memset</span>(&amp;ws_pkt, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">httpd_ws_frame_t</span>));<br><br>    ws_pkt.type = HTTPD_WS_TYPE_TEXT;<br><br>    <span class="hljs-comment">/* Set max_len = 0 to get the frame len */</span><br><br>    <span class="hljs-type">esp_err_t</span> ret = httpd_ws_recv_frame(req, &amp;ws_pkt, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">if</span> (ret != ESP_OK) &#123;<br><br>        ESP_LOGE(TAG, <span class="hljs-string">&quot;httpd_ws_recv_frame failed to get frame len with %d&quot;</span>, ret);<br><br>        <span class="hljs-keyword">return</span> ret;<br><br>    &#125;<br><br>    ESP_LOGI(TAG, <span class="hljs-string">&quot;frame len is %d&quot;</span>, ws_pkt.len);<br><br>    <span class="hljs-keyword">if</span> (ws_pkt.len) &#123;<br><br>        <span class="hljs-comment">/* ws_pkt.len + 1 is for NULL termination as we are expecting a string */</span><br><br>        buf = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, ws_pkt.len + <span class="hljs-number">1</span>);<br><br>        <span class="hljs-keyword">if</span> (buf == <span class="hljs-literal">NULL</span>) &#123;<br><br>            ESP_LOGE(TAG, <span class="hljs-string">&quot;Failed to calloc memory for buf&quot;</span>);<br><br>            <span class="hljs-keyword">return</span> ESP_ERR_NO_MEM;<br><br>        &#125;<br><br>        ws_pkt.payload = buf;<br><br>        <span class="hljs-comment">/* Set max_len = ws_pkt.len to get the frame payload */</span><br><br>        ret = httpd_ws_recv_frame(req, &amp;ws_pkt, ws_pkt.len);<br><br>        <span class="hljs-keyword">if</span> (ret != ESP_OK) &#123;<br><br>            ESP_LOGE(TAG, <span class="hljs-string">&quot;httpd_ws_recv_frame failed with %d&quot;</span>, ret);<br><br>            <span class="hljs-built_in">free</span>(buf);<br><br>            <span class="hljs-keyword">return</span> ret;<br><br>        &#125;<br><br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;Got packet with message: %s&quot;</span>, ws_pkt.payload);<br><br>    &#125;<br><br>    ESP_LOGI(TAG, <span class="hljs-string">&quot;Packet type: %d&quot;</span>, ws_pkt.type);<br><br>    <span class="hljs-keyword">if</span> (ws_pkt.type == HTTPD_WS_TYPE_TEXT &amp;&amp;<br><br>        <span class="hljs-built_in">strcmp</span>((<span class="hljs-type">char</span>*)ws_pkt.payload,<span class="hljs-string">&quot;Trigger async&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br><br>        <span class="hljs-built_in">free</span>(buf);<br><br>        <span class="hljs-keyword">return</span> trigger_async_send(req-&gt;handle, req);<br><br>    &#125;<br><br>  <br><br>    ret = httpd_ws_send_frame(req, &amp;ws_pkt);<br><br>    <span class="hljs-keyword">if</span> (ret != ESP_OK) &#123;<br><br>        ESP_LOGE(TAG, <span class="hljs-string">&quot;httpd_ws_send_frame failed with %d&quot;</span>, ret);<br><br>    &#125;<br><br>    <span class="hljs-built_in">free</span>(buf);<br><br>    <span class="hljs-keyword">return</span> ret;<br><br>&#125;<br><br>  <br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">httpd_uri_t</span> ws = &#123;<br><br>        .uri        = <span class="hljs-string">&quot;/ws&quot;</span>,<br><br>        .method     = HTTP_GET,<br><br>        .handler    = echo_handler,<br><br>        .user_ctx   = <span class="hljs-literal">NULL</span>,<br><br>        .is_websocket = <span class="hljs-literal">true</span><br><br>&#125;;<br></code></pre></td></tr></table></figure>
<h5 id="服务器握手协议"><a href="#服务器握手协议" class="headerlink" title="服务器握手协议"></a>服务器握手协议</h5><p>无</p>
<h5 id="服务器接收数据"><a href="#服务器接收数据" class="headerlink" title="服务器接收数据"></a>服务器接收数据</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c">    <span class="hljs-type">httpd_ws_frame_t</span> ws_pkt;<br><br>    <span class="hljs-type">uint8_t</span> *buf = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-built_in">memset</span>(&amp;ws_pkt, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">httpd_ws_frame_t</span>));<br><br>    ws_pkt.type = HTTPD_WS_TYPE_TEXT;<br><br>    <span class="hljs-comment">/* Set max_len = 0 to get the frame len */</span><br><br>    <span class="hljs-type">esp_err_t</span> ret = httpd_ws_recv_frame(req, &amp;ws_pkt, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">if</span> (ret != ESP_OK) &#123;<br><br>        ESP_LOGE(TAG, <span class="hljs-string">&quot;httpd_ws_recv_frame failed to get frame len with %d&quot;</span>, ret);<br><br>        <span class="hljs-keyword">return</span> ret;<br><br>    &#125;<br><br>    ESP_LOGI(TAG, <span class="hljs-string">&quot;frame len is %d&quot;</span>, ws_pkt.len);<br></code></pre></td></tr></table></figure>
<p>数据格式（和帧格式对应）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> * @brief WebSocket frame format</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">httpd_ws_frame</span> &#123;</span><br><br>    <span class="hljs-type">bool</span> final;                 <span class="hljs-comment">/*!&lt; Final frame:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                                     For received frames this field indicates whether the `FIN` flag was set.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                                     For frames to be transmitted, this field is only used if the `fragmented`</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                                         option is set as well. If `fragmented` is false, the `FIN` flag is set</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                                         by default, marking the ws_frame as a complete/unfragmented message</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                                         (esp_http_server doesn&#x27;t automatically fragment messages) */</span><br><br>    <span class="hljs-type">bool</span> fragmented;            <span class="hljs-comment">/*!&lt; Indication that the frame allocated for transmission is a message fragment,</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                                     so the `FIN` flag is set manually according to the `final` option.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                                     This flag is never set for received messages */</span><br><br>    <span class="hljs-type">httpd_ws_type_t</span> type;       <span class="hljs-comment">/*!&lt; WebSocket frame type */</span><br><br>    <span class="hljs-type">uint8_t</span> *payload;           <span class="hljs-comment">/*!&lt; Pre-allocated data buffer */</span><br><br>    <span class="hljs-type">size_t</span> len;                 <span class="hljs-comment">/*!&lt; Length of the WebSocket data */</span><br><br>&#125; <span class="hljs-type">httpd_ws_frame_t</span>;<br></code></pre></td></tr></table></figure>

<h5 id="服务器发送数据"><a href="#服务器发送数据" class="headerlink" title="服务器发送数据"></a>服务器发送数据</h5><p>异步发送</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">trigger_async_send(req-&gt;handle, req);<br></code></pre></td></tr></table></figure>

<p>同步发送：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">httpd<span class="hljs-constructor">_ws_send_frame(<span class="hljs-params">req</span>, &amp;<span class="hljs-params">ws_pkt</span>)</span>;<br></code></pre></td></tr></table></figure>
<p>这两个函数都调用<code>esp_err_t httpd_ws_send_frame_async(httpd_handle_t hd, int fd, httpd_ws_frame_t *frame)</code><br>httpd_ws_send_frame_async:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">esp_err_t</span> <span class="hljs-title function_">httpd_ws_send_frame_async</span><span class="hljs-params">(<span class="hljs-type">httpd_handle_t</span> hd, <span class="hljs-type">int</span> fd, <span class="hljs-type">httpd_ws_frame_t</span> *frame)</span><br><br>&#123;<br><br>    <span class="hljs-keyword">if</span> (!frame) &#123;<br><br>        ESP_LOGW(TAG, LOG_FMT(<span class="hljs-string">&quot;Argument is invalid&quot;</span>));<br><br>        <span class="hljs-keyword">return</span> ESP_ERR_INVALID_ARG;<br><br>    &#125;<br><br><br>    <span class="hljs-comment">/* Prepare Tx buffer - maximum length is 14, which includes 2 bytes header, 8 bytes length, 4 bytes mask key */</span><br><br>    <span class="hljs-type">uint8_t</span> tx_len = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-type">uint8_t</span> header_buf[<span class="hljs-number">10</span>] = &#123;<span class="hljs-number">0</span> &#125;;<br><br>    <span class="hljs-comment">/* Set the `FIN` bit by default if message is not fragmented. Else, set it as per the `final` field */</span><br><br>    header_buf[<span class="hljs-number">0</span>] |= (!frame-&gt;fragmented) ? HTTPD_WS_FIN_BIT : (frame-&gt;final? HTTPD_WS_FIN_BIT: HTTPD_WS_CONTINUE);<br><br>    header_buf[<span class="hljs-number">0</span>] |= frame-&gt;type; <span class="hljs-comment">/* Type (opcode): 4 bits */</span><br><br><br>    <span class="hljs-keyword">if</span> (frame-&gt;len &lt;= <span class="hljs-number">125</span>) &#123;<br><br>        header_buf[<span class="hljs-number">1</span>] = frame-&gt;len &amp; <span class="hljs-number">0x7f</span>U; <span class="hljs-comment">/* Length for 7 bits */</span><br><br>        tx_len = <span class="hljs-number">2</span>;<br><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (frame-&gt;len &gt; <span class="hljs-number">125</span> &amp;&amp; frame-&gt;len &lt; UINT16_MAX) &#123;<br><br>        header_buf[<span class="hljs-number">1</span>] = <span class="hljs-number">126</span>;                <span class="hljs-comment">/* Length for 16 bits */</span><br><br>        header_buf[<span class="hljs-number">2</span>] = (frame-&gt;len &gt;&gt; <span class="hljs-number">8U</span>) &amp; <span class="hljs-number">0xff</span>U;<br><br>        header_buf[<span class="hljs-number">3</span>] = frame-&gt;len &amp; <span class="hljs-number">0xff</span>U;<br><br>        tx_len = <span class="hljs-number">4</span>;<br><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br><br>        header_buf[<span class="hljs-number">1</span>] = <span class="hljs-number">127</span>;                <span class="hljs-comment">/* Length for 64 bits */</span><br><br>        <span class="hljs-type">uint8_t</span> shift_idx = <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>) - <span class="hljs-number">1</span>; <span class="hljs-comment">/* Shift index starts at 7 */</span><br><br>        <span class="hljs-type">uint64_t</span> len64 = frame-&gt;len; <span class="hljs-comment">/* Raise variable size to make sure we won&#x27;t shift by more bits</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">                                      * than the length has (to avoid undefined behaviour) */</span><br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int8_t</span> idx = <span class="hljs-number">2</span>; idx &lt;= <span class="hljs-number">9</span>; idx++) &#123;<br><br>            <span class="hljs-comment">/* Now do shifting (be careful of endianness, i.e. when buffer index is 2, frame length shift index is 7) */</span><br><br>            header_buf[idx] = (len64 &gt;&gt; (shift_idx * <span class="hljs-number">8</span>)) &amp; <span class="hljs-number">0xff</span>U;<br><br>            shift_idx--;<br><br>        &#125;<br><br>        tx_len = <span class="hljs-number">10</span>;<br><br>    &#125;<br>    <span class="hljs-comment">/* WebSocket server does not required to mask response payload, so leave the MASK bit as 0. */</span><br><br>    header_buf[<span class="hljs-number">1</span>] &amp;= (~HTTPD_WS_MASK_BIT);<br><br>  <br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_db</span> *<span class="hljs-title">sess</span> =</span> httpd_sess_get(hd, fd);<br><br>    <span class="hljs-keyword">if</span> (!sess) &#123;<br><br>        <span class="hljs-keyword">return</span> ESP_ERR_INVALID_ARG;<br><br>    &#125;<br><br>    <span class="hljs-comment">/* Send off header */</span><br><br>    <span class="hljs-keyword">if</span> (sess-&gt;send_fn(hd, fd, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)header_buf, tx_len, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br><br>        ESP_LOGW(TAG, LOG_FMT(<span class="hljs-string">&quot;Failed to send WS header&quot;</span>));<br><br>        <span class="hljs-keyword">return</span> ESP_FAIL;<br><br>    &#125;<br><br>  <br><br>    <span class="hljs-comment">/* Send off payload */</span><br><br>    <span class="hljs-keyword">if</span>(frame-&gt;len &gt; <span class="hljs-number">0</span> &amp;&amp; frame-&gt;payload != <span class="hljs-literal">NULL</span>) &#123;<br><br>        <span class="hljs-keyword">if</span> (sess-&gt;send_fn(hd, fd, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)frame-&gt;payload, frame-&gt;len, <span class="hljs-number">0</span>) &lt; <span class="hljs-number">0</span>) &#123;<br><br>            ESP_LOGW(TAG, LOG_FMT(<span class="hljs-string">&quot;Failed to send WS payload&quot;</span>));<br><br>            <span class="hljs-keyword">return</span> ESP_FAIL;<br><br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> ESP_OK;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>这是一段 ESP32 上通过 WebSocket 发送帧的代码，该函数会向指定的 WebSocket 连接发送加密后的帧数据。主要实现如下：</p>
<ol>
<li>首先对 frame 参数进行校验，如果为空则返回 ESP_ERR_INVALID_ARG 错误。</li>
<li>根据 WebSocket 数据帧格式，设置 Header 的 FIN、Opcode 以及 Payload length 字段。同时根据负载长度的大小决定 Header 的长度，最多为 10 个字节，包括了 2 个字节的 Header，2 个字节的 Payload length，4 个字节的 Masking key（在此代码中未使用，因为 WebSocket Server 不需要对 Payload 进行掩码处理）。</li>
<li>通过 httpd_sess_get() 函数获取对应 WebSocket 连接的套接字描述符（socket descriptor），若获取失败则返回 ESP_ERR_INVALID_ARG 错误。</li>
<li>调用 socket 的 send_fn() 函数，将 Header 和 Payload 发送给客户端。</li>
<li>函数返回 ESP_OK 表示发送数据成功，返回 ESP_FAIL 表示发送数据失败。</li>
</ol>
<h4 id="webSocket客户端"><a href="#webSocket客户端" class="headerlink" title="webSocket客户端"></a>webSocket客户端</h4><p>示例代码：<code>C:\Espressif\frameworks\esp-idf-v4.4.3\examples\protocols\websocket</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* ESP HTTP Client Example</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   This example code is in the Public Domain (or CC0 licensed, at your option.)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   Unless required by applicable law or agreed to in writing, this</span><br><span class="hljs-comment">   software is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR</span><br><span class="hljs-comment">   CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="hljs-comment">*/</span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_wifi.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_system.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;nvs_flash.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_event.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;protocol_examples_common.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;freertos/FreeRTOS.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;freertos/task.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;freertos/semphr.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;freertos/event_groups.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_log.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_websocket_client.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_event.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NO_DATA_TIMEOUT_SEC 5</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *TAG = <span class="hljs-string">&quot;WEBSOCKET&quot;</span>;<br><br><span class="hljs-type">static</span> TimerHandle_t shutdown_signal_timer;<br><span class="hljs-type">static</span> SemaphoreHandle_t shutdown_sema;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">shutdown_signaler</span><span class="hljs-params">(TimerHandle_t xTimer)</span><br>&#123;<br>    ESP_LOGI(TAG, <span class="hljs-string">&quot;No data received for %d seconds, signaling shutdown&quot;</span>, NO_DATA_TIMEOUT_SEC);<br>    xSemaphoreGive(shutdown_sema);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> CONFIG_WEBSOCKET_URI_FROM_STDIN</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">get_string</span><span class="hljs-params">(<span class="hljs-type">char</span> *line, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> (count &lt; size) &#123;<br>        <span class="hljs-type">int</span> c = fgetc(<span class="hljs-built_in">stdin</span>);<br>        <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&#x27;\n&#x27;</span>) &#123;<br>            line[count] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>            <span class="hljs-keyword">break</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c &gt; <span class="hljs-number">0</span> &amp;&amp; c &lt; <span class="hljs-number">127</span>) &#123;<br>            line[count] = c;<br>            ++count;<br>        &#125;<br>        vTaskDelay(<span class="hljs-number">10</span> / portTICK_PERIOD_MS);<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* CONFIG_WEBSOCKET_URI_FROM_STDIN */</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">websocket_event_handler</span><span class="hljs-params">(<span class="hljs-type">void</span> *handler_args, <span class="hljs-type">esp_event_base_t</span> base, <span class="hljs-type">int32_t</span> event_id, <span class="hljs-type">void</span> *event_data)</span><br>&#123;<br>    <span class="hljs-type">esp_websocket_event_data_t</span> *data = (<span class="hljs-type">esp_websocket_event_data_t</span> *)event_data;<br>    <span class="hljs-keyword">switch</span> (event_id) &#123;<br>    <span class="hljs-keyword">case</span> WEBSOCKET_EVENT_CONNECTED:<br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;WEBSOCKET_EVENT_CONNECTED&quot;</span>);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> WEBSOCKET_EVENT_DISCONNECTED:<br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;WEBSOCKET_EVENT_DISCONNECTED&quot;</span>);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> WEBSOCKET_EVENT_DATA:<br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;WEBSOCKET_EVENT_DATA&quot;</span>);<br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;Received opcode=%d&quot;</span>, data-&gt;op_code);<br>        <span class="hljs-keyword">if</span> (data-&gt;op_code == <span class="hljs-number">0x08</span> &amp;&amp; data-&gt;data_len == <span class="hljs-number">2</span>) &#123;<br>            ESP_LOGW(TAG, <span class="hljs-string">&quot;Received closed message with code=%d&quot;</span>, <span class="hljs-number">256</span>*data-&gt;data_ptr[<span class="hljs-number">0</span>] + data-&gt;data_ptr[<span class="hljs-number">1</span>]);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            ESP_LOGW(TAG, <span class="hljs-string">&quot;Received=%.*s&quot;</span>, data-&gt;data_len, (<span class="hljs-type">char</span> *)data-&gt;data_ptr);<br>        &#125;<br>        ESP_LOGW(TAG, <span class="hljs-string">&quot;Total payload length=%d, data_len=%d, current payload offset=%d\r\n&quot;</span>, data-&gt;payload_len, data-&gt;data_len, data-&gt;payload_offset);<br><br>        xTimerReset(shutdown_signal_timer, portMAX_DELAY);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> WEBSOCKET_EVENT_ERROR:<br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;WEBSOCKET_EVENT_ERROR&quot;</span>);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">websocket_app_start</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">esp_websocket_client_config_t</span> websocket_cfg = &#123;&#125;;<br><br>    shutdown_signal_timer = xTimerCreate(<span class="hljs-string">&quot;Websocket shutdown timer&quot;</span>, NO_DATA_TIMEOUT_SEC * <span class="hljs-number">1000</span> / portTICK_PERIOD_MS,<br>                                         pdFALSE, <span class="hljs-literal">NULL</span>, shutdown_signaler);<br>    shutdown_sema = xSemaphoreCreateBinary();<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> CONFIG_WEBSOCKET_URI_FROM_STDIN</span><br>    <span class="hljs-type">char</span> line[<span class="hljs-number">128</span>];<br><br>    ESP_LOGI(TAG, <span class="hljs-string">&quot;Please enter uri of websocket endpoint&quot;</span>);<br>    get_string(line, <span class="hljs-keyword">sizeof</span>(line));<br><br>    websocket_cfg.uri = line;<br>    ESP_LOGI(TAG, <span class="hljs-string">&quot;Endpoint uri: %s\n&quot;</span>, line);<br><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    websocket_cfg.uri = CONFIG_WEBSOCKET_URI;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* CONFIG_WEBSOCKET_URI_FROM_STDIN */</span></span><br><br>    ESP_LOGI(TAG, <span class="hljs-string">&quot;Connecting to %s...&quot;</span>, websocket_cfg.uri);<br><br>    <span class="hljs-type">esp_websocket_client_handle_t</span> client = esp_websocket_client_init(&amp;websocket_cfg);<br>    esp_websocket_register_events(client, WEBSOCKET_EVENT_ANY, websocket_event_handler, (<span class="hljs-type">void</span> *)client);<br><br>    esp_websocket_client_start(client);<br>    xTimerStart(shutdown_signal_timer, portMAX_DELAY);<br>    <span class="hljs-type">char</span> data[<span class="hljs-number">32</span>];<br>    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> (i &lt; <span class="hljs-number">5</span>) &#123;<br>        <span class="hljs-keyword">if</span> (esp_websocket_client_is_connected(client)) &#123;<br>            <span class="hljs-type">int</span> len = <span class="hljs-built_in">sprintf</span>(data, <span class="hljs-string">&quot;hello %04d&quot;</span>, i++);<br>            ESP_LOGI(TAG, <span class="hljs-string">&quot;Sending %s&quot;</span>, data);<br>            esp_websocket_client_send_text(client, data, len, portMAX_DELAY);<br>        &#125;<br>        vTaskDelay(<span class="hljs-number">1000</span> / portTICK_RATE_MS);<br>    &#125;<br><br>    xSemaphoreTake(shutdown_sema, portMAX_DELAY);<br>    esp_websocket_client_close(client, portMAX_DELAY);<br>    ESP_LOGI(TAG, <span class="hljs-string">&quot;Websocket Stopped&quot;</span>);<br>    esp_websocket_client_destroy(client);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">app_main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    ESP_LOGI(TAG, <span class="hljs-string">&quot;[APP] Startup..&quot;</span>);<br>    ESP_LOGI(TAG, <span class="hljs-string">&quot;[APP] Free memory: %d bytes&quot;</span>, esp_get_free_heap_size());<br>    ESP_LOGI(TAG, <span class="hljs-string">&quot;[APP] IDF version: %s&quot;</span>, esp_get_idf_version());<br>    esp_log_level_set(<span class="hljs-string">&quot;*&quot;</span>, ESP_LOG_INFO);<br>    esp_log_level_set(<span class="hljs-string">&quot;WEBSOCKET_CLIENT&quot;</span>, ESP_LOG_DEBUG);<br>    esp_log_level_set(<span class="hljs-string">&quot;TRANSPORT_WS&quot;</span>, ESP_LOG_DEBUG);<br>    esp_log_level_set(<span class="hljs-string">&quot;TRANS_TCP&quot;</span>, ESP_LOG_DEBUG);<br><br>    ESP_ERROR_CHECK(nvs_flash_init());<br>    ESP_ERROR_CHECK(esp_netif_init());<br>    ESP_ERROR_CHECK(esp_event_loop_create_default());<br><br>    <span class="hljs-comment">/* This helper function configures Wi-Fi or Ethernet, as selected in menuconfig.</span><br><span class="hljs-comment">     * Read &quot;Establishing Wi-Fi or Ethernet Connection&quot; section in</span><br><span class="hljs-comment">     * examples/protocols/README.md for more information about this function.</span><br><span class="hljs-comment">     */</span><br>    ESP_ERROR_CHECK(example_connect());<br><br>    websocket_app_start();<br>&#125;<br><br><br></code></pre></td></tr></table></figure>
<p>工作流程：<br><img src="/2023/06/06/4.%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/ESP32wifi%E5%85%A5%E9%97%A8/img30115017.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="6-MQTT协议"><a href="#6-MQTT协议" class="headerlink" title="6.MQTT协议"></a>6.MQTT协议</h3><h4 id="MQTT介绍"><a href="#MQTT介绍" class="headerlink" title="MQTT介绍"></a>MQTT介绍</h4><p><a target="_blank" rel="noopener" href="https://mqtt.org/">MQTT官网</a><br>MQTT（Message Queuing Telemetry Transport）是一种轻量级的、基于发布-订阅模式的通信协议，主要应用于物联网（IoT）领域中设备间的通信。<br><img src="/2023/06/06/4.%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/ESP32wifi%E5%85%A5%E9%97%A8/img30120007.png" srcset="/img/loading.gif" lazyload><br>MQTT 协议采用了简单的二进制编码格式，使得它适用于网络带宽较小、延迟较高、网络不稳定的环境下进行通信。同时，MQTT 提供了 QoS（Quality of Service）服务质量保证机制，支持三种不同的 QoS 等级：</p>
<ul>
<li>QoS 0：最多发送一次消息，不提供可靠性保证。</li>
<li>QoS 1：至少发送一次消息，确保消息能到达接收方，但可能会重复。</li>
<li>QoS 2：恰好发送一次消息，确保消息能到达接收方且只接收一次。</li>
</ul>
<p>MQTT 协议的特点包括：可扩展性好、开销小、易于实现、开源、支持多种编程语言等。</p>
<p>在 MQTT 协议中，存在两个主要的参与者：发布者和订阅者。发布者将消息发布到一个或多个主题（Topic）中，订阅者可以订阅感兴趣的主题，从而接收到发布者发送的消息。主题可以看作是某一个特定类型的消息的分类标准。</p>
<p>MQTT 协议的使用场景包括但不限于：智能家居、智能灯光、智能安防、农业物联网、工业物联网等。</p>
<h5 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h5><h6 id="轻巧高效"><a href="#轻巧高效" class="headerlink" title="轻巧高效"></a>轻巧高效</h6><p>MQTT 客户端非常小，需要的资源最少，因此可以在小型微控制器上使用。MQTT 消息头很小，可以优化网络带宽。</p>
<h6 id="双向通信"><a href="#双向通信" class="headerlink" title="双向通信"></a>双向通信</h6><p>MQTT 允许在设备到云和云到设备之间进行消息传递。这使得向事物组广播消息变得容易。</p>
<h6 id="扩展到数百万个事物"><a href="#扩展到数百万个事物" class="headerlink" title="扩展到数百万个事物"></a>扩展到数百万个事物</h6><p>MQTT 可以扩展以连接数百万个物联网设备。</p>
<h6 id="可靠的消息传递"><a href="#可靠的消息传递" class="headerlink" title="可靠的消息传递"></a>可靠的消息传递</h6><p>消息传递的可靠性对于许多物联网用例都很重要。这就是为什么 MQTT 有 3 个定义的服务质量级别：0 - 最多一次，1 - 至少一次，2 - 恰好一次</p>
<h6 id="支持不可靠的网络"><a href="#支持不可靠的网络" class="headerlink" title="支持不可靠的网络"></a>支持不可靠的网络</h6><p>许多物联网设备通过不可靠的蜂窝网络连接。MQTT 对持久会话的支持减少了将客户端与代理重新连接的时间。</p>
<h6 id="已启用安全性"><a href="#已启用安全性" class="headerlink" title="已启用安全性"></a>已启用安全性</h6><p>MQTT 使使用 TLS 加密消息和使用现代身份验证协议（如 OAuth）对客户端进行身份验证变得容易。</p>
<h4 id="MQTT包协议"><a href="#MQTT包协议" class="headerlink" title="MQTT包协议"></a>MQTT包协议</h4><p>MQTT 控制数据包的结构：<br><img src="/2023/06/06/4.%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/ESP32wifi%E5%85%A5%E9%97%A8/img30121011.png" srcset="/img/loading.gif" lazyload><br>········<br>其余具体见规范文档：<a href="mqtt-v5.0.pdf">MQTT协议：mqtt-v5.0.pdf)</a></p>
<h4 id="MQTT客户端"><a href="#MQTT客户端" class="headerlink" title="MQTT客户端"></a>MQTT客户端</h4><p>示例代码：<code>C:\Espressif\frameworks\esp-idf-v4.4.3\examples\protocols\mqtt\tcp </code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* MQTT (over TCP) Example</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   This example code is in the Public Domain (or CC0 licensed, at your option.)</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">   Unless required by applicable law or agreed to in writing, this</span><br><span class="hljs-comment">   software is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR</span><br><span class="hljs-comment">   CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_wifi.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_system.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;nvs_flash.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_event.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_netif.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;protocol_examples_common.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;freertos/FreeRTOS.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;freertos/task.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;freertos/semphr.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;freertos/queue.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;freertos/timers.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;lwip/sockets.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;lwip/dns.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;lwip/netdb.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;esp_log.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;mqtt_client.h&quot;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *TAG = <span class="hljs-string">&quot;MQTT_EXAMPLE&quot;</span>;<br><span class="hljs-comment">//--------------------------------------------------------------、</span><br><span class="hljs-comment">//定时器</span><br><span class="hljs-type">static</span> <span class="hljs-type">timer_handle_t</span> mqtt_timer;<br><span class="hljs-type">int</span> iID = <span class="hljs-number">0</span>;<br><span class="hljs-type">esp_mqtt_client_handle_t</span> client=<span class="hljs-literal">NULL</span>;<br><span class="hljs-comment">//定时器回调函数</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">mqtt_timer_callback</span><span class="hljs-params">(<span class="hljs-type">timer_handle_t</span> xTimer)</span>;<br>&#123;<br>    ESP_LOGI(TAG, <span class="hljs-string">&quot;MQTT Timer callback&quot;</span>);<br>    <span class="hljs-type">char</span> str_arr[<span class="hljs-number">15</span>]=<span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-built_in">sprintf</span>(str_arr, <span class="hljs-string">&quot;data %d&quot;</span>, iID);<br>    iID++;<br>    <span class="hljs-keyword">if</span>(IID &gt; <span class="hljs-number">10</span>)<br>    &#123;<br>        iID = <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(client!=<span class="hljs-literal">NULL</span>)<br>    &#123;<br>        <span class="hljs-type">int</span> msg_id=esp_mqtt_client_publish(client, <span class="hljs-string">&quot;/topic/qos1&quot;</span>, str_arr, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;sent publish successful, msg_id=%d&quot;</span>, msg_id);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;MQTT client is NULL&quot;</span>);<br>    &#125;<br><br>&#125;<br><br><span class="hljs-comment">//--------------------------------------------------------------</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">log_error_if_nonzero</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *message, <span class="hljs-type">int</span> error_code)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (error_code != <span class="hljs-number">0</span>) &#123;<br>        ESP_LOGE(TAG, <span class="hljs-string">&quot;Last error %s: 0x%x&quot;</span>, message, error_code);<br>        <br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * @brief Event handler registered to receive MQTT events</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *  This function is called by the MQTT client event loop.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @param handler_args user data registered to the event.</span><br><span class="hljs-comment"> * @param base Event base for the handler(always MQTT Base in this example).</span><br><span class="hljs-comment"> * @param event_id The id for the received event.</span><br><span class="hljs-comment"> * @param event_data The data for the event, esp_mqtt_event_handle_t.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">mqtt_event_handler</span><span class="hljs-params">(<span class="hljs-type">void</span> *handler_args, <span class="hljs-type">esp_event_base_t</span> base, <span class="hljs-type">int32_t</span> event_id, <span class="hljs-type">void</span> *event_data)</span><br>&#123;<br>    ESP_LOGD(TAG, <span class="hljs-string">&quot;Event dispatched from event loop base=%s, event_id=%d&quot;</span>, base, event_id);<br>    <span class="hljs-type">esp_mqtt_event_handle_t</span> event = event_data;<br>    client = event-&gt;client;<br>    <span class="hljs-type">int</span> msg_id;<br>    <span class="hljs-keyword">switch</span> ((<span class="hljs-type">esp_mqtt_event_id_t</span>)event_id) &#123;<br>    <span class="hljs-keyword">case</span> MQTT_EVENT_CONNECTED:<br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;MQTT_EVENT_CONNECTED&quot;</span>);<br>        msg_id = esp_mqtt_client_subscribe(client, <span class="hljs-string">&quot;/topic/qos1&quot;</span>, <span class="hljs-number">0</span>);<br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;sent subscribe successful, msg_id=%d&quot;</span>, msg_id);<br><br>        mqtt_timer = xTimerCreate(<span class="hljs-string">&quot;mqtt_timer&quot;</span>, pdMS_TO_TICKS(<span class="hljs-number">5000</span>), pdTRUE, <span class="hljs-literal">NULL</span>, mqtt_timer_callback);<br>        timter_start(mqtt_timer, portMAX_DELAY);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> MQTT_EVENT_DISCONNECTED:<br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;MQTT_EVENT_DISCONNECTED&quot;</span>);<br>        timter_stop(mqtt_timer, portMAX_DELAY);<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> MQTT_EVENT_SUBSCRIBED:<br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;MQTT_EVENT_SUBSCRIBED, msg_id=%d&quot;</span>, event-&gt;msg_id);<br>        <span class="hljs-comment">//msg_id = esp_mqtt_client_publish(client, &quot;/topic/qos0&quot;, &quot;data&quot;, 0, 0, 0);</span><br>        <span class="hljs-comment">//ESP_LOGI(TAG, &quot;sent publish successful, msg_id=%d&quot;, msg_id);</span><br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> MQTT_EVENT_UNSUBSCRIBED:<br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;MQTT_EVENT_UNSUBSCRIBED, msg_id=%d&quot;</span>, event-&gt;msg_id);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> MQTT_EVENT_PUBLISHED:<br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;MQTT_EVENT_PUBLISHED, msg_id=%d&quot;</span>, event-&gt;msg_id);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> MQTT_EVENT_DATA:<br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;MQTT_EVENT_DATA&quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;TOPIC=%.*s\r\n&quot;</span>, event-&gt;topic_len, event-&gt;topic);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;DATA=%.*s\r\n&quot;</span>, event-&gt;data_len, event-&gt;data);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> MQTT_EVENT_ERROR:<br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;MQTT_EVENT_ERROR&quot;</span>);<br>        <span class="hljs-keyword">if</span> (event-&gt;error_handle-&gt;error_type == MQTT_ERROR_TYPE_TCP_TRANSPORT) &#123;<br>            log_error_if_nonzero(<span class="hljs-string">&quot;reported from esp-tls&quot;</span>, event-&gt;error_handle-&gt;esp_tls_last_esp_err);<br>            log_error_if_nonzero(<span class="hljs-string">&quot;reported from tls stack&quot;</span>, event-&gt;error_handle-&gt;esp_tls_stack_err);<br>            log_error_if_nonzero(<span class="hljs-string">&quot;captured as transport&#x27;s socket errno&quot;</span>,  event-&gt;error_handle-&gt;esp_transport_sock_errno);<br>            ESP_LOGI(TAG, <span class="hljs-string">&quot;Last errno string (%s)&quot;</span>, strerror(event-&gt;error_handle-&gt;esp_transport_sock_errno));<br><br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:    <br>        ESP_LOGI(TAG, <span class="hljs-string">&quot;Other event id:%d&quot;</span>, event-&gt;event_id);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">mqtt_app_start</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">esp_mqtt_client_config_t</span> mqtt_cfg = &#123;<br>        .uri = CONFIG_BROKER_URL,<br>    &#125;;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> CONFIG_BROKER_URL_FROM_STDIN</span><br>    <span class="hljs-type">char</span> line[<span class="hljs-number">128</span>];<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(mqtt_cfg.uri, <span class="hljs-string">&quot;FROM_STDIN&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Please enter url of mqtt broker\n&quot;</span>);<br>        <span class="hljs-keyword">while</span> (count &lt; <span class="hljs-number">128</span>) &#123;<br>            <span class="hljs-type">int</span> c = fgetc(<span class="hljs-built_in">stdin</span>);<br>            <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&#x27;\n&#x27;</span>) &#123;<br>                line[count] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>                <span class="hljs-keyword">break</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c &gt; <span class="hljs-number">0</span> &amp;&amp; c &lt; <span class="hljs-number">127</span>) &#123;<br>                line[count] = c;<br>                ++count;<br>            &#125;<br>            vTaskDelay(<span class="hljs-number">10</span> / portTICK_PERIOD_MS);<br>        &#125;<br>        mqtt_cfg.uri = line;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Broker url: %s\n&quot;</span>, line);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        ESP_LOGE(TAG, <span class="hljs-string">&quot;Configuration mismatch: wrong broker url&quot;</span>);<br>        <span class="hljs-built_in">abort</span>();<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">/* CONFIG_BROKER_URL_FROM_STDIN */</span></span><br><br>    <span class="hljs-type">esp_mqtt_client_handle_t</span> client = esp_mqtt_client_init(&amp;mqtt_cfg);<br>    <span class="hljs-comment">/* The last argument may be used to pass data to the event handler, in this example mqtt_event_handler */</span><br>    esp_mqtt_client_register_event(client, ESP_EVENT_ANY_ID, mqtt_event_handler, <span class="hljs-literal">NULL</span>);<br>    esp_mqtt_client_start(client);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">app_main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    ESP_LOGI(TAG, <span class="hljs-string">&quot;[APP] Startup..&quot;</span>);<br>    ESP_LOGI(TAG, <span class="hljs-string">&quot;[APP] Free memory: %d bytes&quot;</span>, esp_get_free_heap_size());<br>    ESP_LOGI(TAG, <span class="hljs-string">&quot;[APP] IDF version: %s&quot;</span>, esp_get_idf_version());<br><br>    esp_log_level_set(<span class="hljs-string">&quot;*&quot;</span>, ESP_LOG_INFO);<br>    esp_log_level_set(<span class="hljs-string">&quot;MQTT_CLIENT&quot;</span>, ESP_LOG_VERBOSE);<br>    esp_log_level_set(<span class="hljs-string">&quot;MQTT_EXAMPLE&quot;</span>, ESP_LOG_VERBOSE);<br>    esp_log_level_set(<span class="hljs-string">&quot;TRANSPORT_BASE&quot;</span>, ESP_LOG_VERBOSE);<br>    esp_log_level_set(<span class="hljs-string">&quot;esp-tls&quot;</span>, ESP_LOG_VERBOSE);<br>    esp_log_level_set(<span class="hljs-string">&quot;TRANSPORT&quot;</span>, ESP_LOG_VERBOSE);<br>    esp_log_level_set(<span class="hljs-string">&quot;OUTBOX&quot;</span>, ESP_LOG_VERBOSE);<br><br>    ESP_ERROR_CHECK(nvs_flash_init());<br>    ESP_ERROR_CHECK(esp_netif_init());<br>    ESP_ERROR_CHECK(esp_event_loop_create_default());<br><br>    <span class="hljs-comment">/* This helper function configures Wi-Fi or Ethernet, as selected in menuconfig.</span><br><span class="hljs-comment">     * Read &quot;Establishing Wi-Fi or Ethernet Connection&quot; section in</span><br><span class="hljs-comment">     * examples/protocols/README.md for more information about this function.</span><br><span class="hljs-comment">     */</span><br>    ESP_ERROR_CHECK(example_connect());<br><br>    mqtt_app_start();<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>这是一个 ESP32 的 MQTT 示例程序，用于通过 TCP 连接到 MQTT 代理。程序实现了连接、订阅、发布等 MQTT 协议常用功能，并且使用了定时器来定时发送消息。</p>
<p>程序的主要框架如下：</p>
<ul>
<li>初始化日志记录级别</li>
<li>初始化 NVS 文件系统、网络接口、事件循环</li>
<li>连接 Wi-Fi 或者以太网</li>
<li>启动 MQTT 客户端</li>
<li>注册 MQTT 事件处理回调函数</li>
<li>在 MQTT_CONNECTED 事件中创建并启动定时器</li>
<li>当接收到其他 MQTT 事件时，做相应的处理（如订阅成功、接收到数据等）</li>
</ul>
<p>其中，定时器回调函数 mqtt_timer_callback 每隔 5 秒会向 &#x2F;topic&#x2F;qos1 主题发布一条消息，消息内容为 “data iID”，其中 iID 是递增的计数器，每发送 10 条消息后归零重新开始。如果 MQTT 客户端未连接则不进行操作。</p>
<h3 id="7-ESP-NOW协议"><a href="#7-ESP-NOW协议" class="headerlink" title="7.ESP-NOW协议"></a>7.ESP-NOW协议</h3><h4 id="ESP-NOW介绍"><a href="#ESP-NOW介绍" class="headerlink" title="ESP-NOW介绍"></a>ESP-NOW介绍</h4><p>ESP-NOW 是一种由乐鑫公司定义的无连接 Wi-Fi 通信协议。在 ESP-NOW 中，应用程序数据被封装在各个供应商的动作帧中，然后在无连接的情况下，从一个 Wi-Fi 设备传输到另一个 Wi-Fi 设备。 CTR 与 CBC-MAC 协议 (CCMP) 可用来保护动作帧的安全。ESP-NOW 广泛应用于智能照明、远程控制、传感器等领域。</p>
<h4 id="ESP-NOW帧格式"><a href="#ESP-NOW帧格式" class="headerlink" title="ESP-NOW帧格式"></a>ESP-NOW帧格式</h4><p>ESP-NOW 使用各个供应商的动作帧传输数据，默认比特率为 1 Mbps。各个供应商的动作帧格式为：</p>
<table>
<thead>
<tr>
<th>MAC 报头</th>
<th>分类代码</th>
<th>组织标识符</th>
<th>随机值</th>
<th>供应商特定内容</th>
<th>FCS</th>
</tr>
</thead>
<tbody><tr>
<td>24 字节</td>
<td>1 字节</td>
<td>3 字节</td>
<td>4 字节</td>
<td>7~257 字节</td>
<td>4 字节</td>
</tr>
</tbody></table>
<ul>
<li>分类代码：分类代码字段可用于指示各个供应商的类别（比如 127）。</li>
<li>组织标识符：组织标识符包含一个唯一标识符 (比如 0x18fe34)，为乐鑫指定的 MAC 地址的前三个字节。</li>
<li>随机值：防止重放攻击。</li>
<li>供应商特定内容：供应商特定内容包含供应商特定字段，如下所示：</li>
</ul>
<table>
<thead>
<tr>
<th>元素 ID</th>
<th>长度</th>
<th>组织标识符</th>
<th>类型</th>
<th>版本</th>
<th>正文</th>
</tr>
</thead>
<tbody><tr>
<td>1 字节</td>
<td>1 字节</td>
<td>3 字节</td>
<td>1 字节</td>
<td>1 字节</td>
<td>0～250 字节</td>
</tr>
</tbody></table>
<ul>
<li><p>元素 ID：元素 ID 字段可用于指示特定于供应商的元素。</p>
</li>
<li><p>长度：长度是组织标识符、类型、版本和正文的总长度。</p>
</li>
<li><p>组织标识符：组织标识符包含一个唯一标识符 (比如 0x18fe34)，为乐鑫指定的 MAC 地址的前三个字节。</p>
</li>
<li><p>类型：类型字段设置为 4，代表 ESP-NOW。</p>
</li>
<li><p>版本：版本字段设置为 ESP-NOW 的版本。</p>
</li>
<li><p>正文：正文包含 ESP-NOW 数据。</p>
</li>
</ul>
<p>由于 ESP-NOW 是无连接的，因此 MAC 报头与标准帧略有不同。FrameControl 字段的 FromDS 和 ToDS 位均为 0。第一个地址字段用于配置目标地址。第二个地址字段用于配置源地址。第三个地址字段用于配置广播地址 (0xff:0xff:0xff:0xff:0xff:0xff)。</p>
<h4 id="ESP-NOW发送数据"><a href="#ESP-NOW发送数据" class="headerlink" title="ESP-NOW发送数据"></a>ESP-NOW发送数据</h4><h4 id="ESP-NOW接收数据"><a href="#ESP-NOW接收数据" class="headerlink" title="ESP-NOW接收数据"></a>ESP-NOW接收数据</h4><h4 id="ESP-NOW广播数据"><a href="#ESP-NOW广播数据" class="headerlink" title="ESP-NOW广播数据"></a>ESP-NOW广播数据</h4><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E7%94%B5%E5%AD%90%E4%BF%A1%E6%81%AF%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/" class="category-chain-item">电子信息硬件相关</a>
  
  
    <span>></span>
    
  <a href="/categories/%E7%94%B5%E5%AD%90%E4%BF%A1%E6%81%AF%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/" class="category-chain-item">MCU</a>
  
  
    <span>></span>
    
  <a href="/categories/%E7%94%B5%E5%AD%90%E4%BF%A1%E6%81%AF%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/" class="category-chain-item">ESP32</a>
  
  
    <span>></span>
    
  <a href="/categories/%E7%94%B5%E5%AD%90%E4%BF%A1%E6%81%AF%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/ESP32/WIFI/" class="category-chain-item">WIFI</a>
  
  

  

  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/ESP32/">#ESP32</a>
      
        <a href="/tags/MCU/">#MCU</a>
      
        <a href="/tags/WIFI/">#WIFI</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ESP32wifi入门</div>
      <div>https://www.duruofu.xyz/2023/06/06/4.硬件相关/MCU/ESP32/ESP32wifi入门/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>DuRuofu</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年6月6日</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>更新于</div>
          <div>2024年1月5日</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
                <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="NC - 非商业性使用">
                    <i class="iconfont icon-nc"></i>
                  </span>
                </a>
              
                <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="SA - 相同方式共享">
                    <i class="iconfont icon-sa"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/06/06/5.%E6%80%BB%E7%BB%93%E8%BE%93%E5%87%BA/%E7%8E%AF%E5%A2%83(%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2)/%E5%9F%BA%E4%BA%8EEMQX%E7%9A%84mqtt%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%A8%E7%BD%B2/" title="基于EMQX的mqtt服务器部署">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">基于EMQX的mqtt服务器部署</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/06/06/4.%E7%A1%AC%E4%BB%B6%E7%9B%B8%E5%85%B3/MCU/STM32/STM32F1%E7%B3%BB%E5%88%97%E7%A7%BB%E6%A4%8Dfreertos/" title="STM32F1系列移植freertos">
                        <span class="hidden-mobile">STM32F1系列移植freertos</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://lib.baomitu.com/gitalk/1.8.0/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"c9ac06d5413a9d613a1e","clientSecret":"a44f5c72589eb090876cc64067db28fbfdf4747c","repo":"Blog-comments-gitalk","owner":"DuRuofu","admin":["DuRuofu"],"language":"zh-CN","labels":["Gitalk"],"perPage":15,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":false,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: 'a36fc8d194307507ac6589dd463f4fe8'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <br><span id="timeDate">天数载入中</span><span id="times">...</span><br> <span>总有读不懂的诗和到达不了的远方</span> <p>Copyright © 2023 - <span id="currentYear"></span> All Rights Reserved.</p>
    </div>
  
<span style="font-size: smaller;" >  😊目前为止，已经码字：752k</span>
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  

  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      陕ICP备2022007454号
    </a>
  </span>
  
    
      <span>
        <a
          href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=2022007454"
          rel="nofollow noopener"
          class="beian-police"
          target="_blank"
        >
          
            <span style="visibility: hidden; width: 0">|</span>
            <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
          
          <span>陕ICP备2022007454号-2</span>
        </a>
      </span>
    
  
</div>

  
  

</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":true,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  
<script src="/cust/custom.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
